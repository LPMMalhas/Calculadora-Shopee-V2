<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velt.AI - Precifica√ß√£o Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .shopee-gradient { background: linear-gradient(135deg, #ee4d2d 0%, #ff7337 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        input[type=range] { accent-color: #ee4d2d; }
        input:focus { ring: 2px; ring-color: #ee4d2d; border-color: #ee4d2d; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ee4d2d; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        
        /* Custom Scrollbar for Table */
        .table-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }

        /* ESTILOS DE IMPRESS√ÉO (PDF - OTIMIZADO A4) */
        @media print {
            @page { margin: 0.3cm; size: A4; }
            
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                font-size: 10px; 
            }

            /* Ocultar elementos de navega√ß√£o e intera√ß√£o */
            #login-screen, button, .no-print, #tab-calc, #tab-dash, #tab-ads,
            #auth-status-container, #firebase-help, .fa-print, .fa-sign-out-alt, 
            input[type=range], #btn-delete, #btn-save, .fa-plus, .fa-save, .fa-trash-alt, .fa-eraser,
            #ads-saved-products, .fa-chevron-down, .action-bar, #dash-search-container,
            #prod-name-label, #prod-name, #shopee-2026-config { 
                display: none !important; 
            }

            #app-content { 
                box-shadow: none; max-width: 100%; width: 100%; margin: 0; border-radius: 0;
                transform: scale(0.95);
                transform-origin: top center;
                overflow: visible;
            }

            /* For√ßar visibilidade do nome do produto APENAS no print */
            #prod-name-print {
                display: block !important;
                width: 100% !important;
                white-space: normal !important;
                word-break: break-all !important; 
                overflow-wrap: break-word !important;
                margin-bottom: 10px !important;
            }
            
            /* Ajuste do container pai para garantir largura total na impress√£o */
            #prod-name-container {
                display: block !important;
                width: 100% !important;
                flex: none !important;
            }

            .shopee-gradient { 
                background: #ee4d2d !important; color: white !important; 
                -webkit-print-color-adjust: exact; padding: 10px !important;
                border-radius: 0 !important; margin-bottom: 5px !important;
            }
            .shopee-gradient h1 { font-size: 14px !important; }
            .shopee-gradient p { font-size: 8px !important; }

            .p-6, .p-8, .md\:p-8 { padding: 0 !important; }
            .p-5, .p-4 { padding: 5px !important; }
            
            .space-y-8 > :not([hidden]) ~ :not([hidden]) { margin-top: 10px !important; }
            .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 5px !important; }
            .mb-8, .mb-4, .mb-3, .mb-2 { margin-bottom: 3px !important; }
            .mt-6, .mt-5, .mt-4 { margin-top: 5px !important; }
            .gap-4 { gap: 5px !important; }
            .gap-3 { gap: 4px !important; }
            
            input, select { 
                border: none !important; background: transparent !important; 
                appearance: none; -webkit-appearance: none; padding: 0 !important; 
                font-weight: bold; color: #000; font-size: 11px !important;
                height: auto !important; width: auto !important; display: inline-block;
            }

            .bg-gray-50, .bg-blue-50, .bg-red-50, .bg-green-50, .bg-orange-50, .bg-purple-50, .bg-yellow-50 {
                background-color: transparent !important;
                border: 1px solid #e5e7eb !important; border-radius: 4px !important;
                padding: 5px !important;
            }
            
            /* QUEBRA DE P√ÅGINA */
            #organic-simulation-wrapper {
                page-break-before: always;
                margin-top: 20px !important;
                display: block !important;
            }
            
            #breakdown-container {
                page-break-inside: avoid;
            }
            
            .hidden { display: none !important; } 
            
            .fa-chevron-down, .absolute.left-3, .absolute.right-3 { display: none !important; }
            input[type=number] { padding-left: 0 !important; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col items-center justify-center py-4 md:py-8 px-4">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="w-full max-w-sm bg-white rounded-3xl overflow-hidden card-shadow p-8 transition-all">
        <div class="text-center mb-8">
            <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                <i class="fas fa-rocket text-4xl text-[#ee4d2d]"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-800">Velt.AI Cloud</h1>
            <p class="text-sm text-gray-400 mt-1">Precifica√ß√£o Inteligente & Ads</p>
        </div>

        <div class="space-y-4">
            <div id="firebase-help" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-left mb-4">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                    <div>
                        <h4 class="text-xs font-bold text-yellow-800 uppercase">Configura√ß√£o Necess√°ria</h4>
                        <p class="text-[10px] text-yellow-700 mt-1 leading-relaxed">
                            Ative <b>Email/Password</b> e <b>Anonymous</b> no Firebase Console.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">E-mail</label>
                <input type="email" id="login-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="seu@email.com">
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Senha</label>
                <input type="password" id="login-password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="********">
            </div>
            
            <div id="login-error" class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-600 text-xs text-center hidden"></div>

            <button onclick="window.fazerLogin()" id="btn-login" class="w-full py-3.5 shopee-gradient text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition-all">
                Entrar
            </button>
            
            <button onclick="window.fazerLoginAnonimo()" id="btn-guest" class="w-full py-2 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-all text-xs uppercase">
                Entrar como Convidado
            </button>
            
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-xs">ou</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <button onclick="window.fazerCadastro()" id="btn-register" class="w-full py-3.5 bg-white border-2 border-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition-all">
                Criar Conta Gr√°tis
            </button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden w-full max-w-4xl bg-white rounded-3xl overflow-hidden card-shadow transition-all duration-300">
        
        <!-- Header -->
        <div class="shopee-gradient p-6 text-white text-center relative flex justify-between items-center">
            <div class="w-8"></div>
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight">Velt.AI <span class="font-light opacity-90">| Cloud</span></h1>
                <p class="text-xs font-medium uppercase tracking-widest mt-1 opacity-90">Precifica√ß√£o, Ads & Firebase</p>
            </div>
            <div class="flex gap-4">
                <i class="fas fa-print cursor-pointer text-white text-xl opacity-80 hover:opacity-100 transition-opacity" onclick="window.imprimirRelatorio()" title="Imprimir / Salvar PDF"></i>
                <i class="fas fa-sign-out-alt cursor-pointer text-white text-xl opacity-60 hover:opacity-100 transition-opacity no-print" onclick="window.fazerLogout()" title="Sair da Conta"></i>
            </div>
        </div>

        <!-- Navega√ß√£o Tabs -->
        <div class="flex border-b border-gray-200 bg-white sticky top-0 z-10 no-print">
            <button id="tab-calc" onclick="window.switchTab('calc')" class="flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-calculator mr-1"></i> Calculadora
            </button>
            <button id="tab-ads" onclick="window.switchTab('ads')" class="flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-search-dollar mr-1"></i> An√°lise Ads
            </button>
            <button id="tab-dash" onclick="window.switchTab('dash')" class="flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-chart-line mr-1"></i> Dashboard
            </button>
        </div>

        <!-- ABA CALCULADORA -->
        <div id="view-calc" class="p-6 md:p-8 space-y-8 animate-fade-in">

            <!-- GEST√ÉO DE PRODUTOS -->
            <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 md:p-5 relative">
                <div class="absolute -top-3 left-4 bg-gray-800 text-white text-[10px] font-bold px-2 py-0.5 rounded no-print">GEST√ÉO DE PRODUTOS</div>
                
                <div class="flex justify-between items-center mb-3" id="auth-status-container">
                    <div id="db-mode" class="text-[9px] font-bold uppercase text-gray-400">Projeto Pessoal</div>
                    <div class="text-[10px] text-right text-gray-400 flex items-center gap-2">
                        <span id="auth-status">Conectado</span>
                        <span id="badge-mode" class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]">NOVO</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3 mb-4">
                    <div class="flex-grow" id="prod-name-container">
                        <label id="prod-name-label" class="text-[10px] font-bold text-gray-500 uppercase tracking-wide print:hidden">Nome do Produto</label>
                        <!-- Input para digitar -->
                        <input type="text" id="prod-name" placeholder="Ex: Tenis_Corrida" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold outline-none focus:border-orange-500 uppercase transition-all">
                        <!-- Elemento EXCLUSIVO para impress√£o (com quebra de linha for√ßada) -->
                        <div id="prod-name-print" class="hidden text-xl font-black uppercase text-gray-800 border-b-2 border-orange-500 pb-1 mb-2 break-all whitespace-normal leading-tight"></div>
                        <input type="hidden" id="prod-id">
                    </div>
                    <div class="flex items-end gap-2 no-print">
                        <button onclick="window.novoProduto()" class="py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-50 transition-all h-[42px]" title="Limpar Campos / Novo Produto">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="window.salvarProduto()" id="btn-save" class="py-2 px-6 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-bold shadow-sm transition-all flex items-center justify-center gap-2 h-[42px] min-w-[120px]">
                            <i class="fas fa-save"></i> <span id="btn-save-text">Salvar</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-end gap-2 no-print">
                    <div class="flex-grow relative">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Carregar Produto Salvo</label>
                        <select id="saved-products" onchange="window.carregarProduto(this.value)" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm outline-none cursor-pointer appearance-none">
                            <option value="">Selecione um produto...</option>
                        </select>
                        <div class="absolute right-3 bottom-2.5 pointer-events-none text-gray-400"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>
                    <button onclick="window.excluirProduto()" id="btn-delete" class="py-2 px-4 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm font-bold shadow-sm hover:bg-red-100 hover:border-red-300 transition-all h-[42px] hidden" title="Excluir Este Produto">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 no-print action-bar">
                    <button onclick="window.limparCalculadora()" class="text-[10px] font-bold text-red-500 hover:text-red-700 flex items-center gap-1 uppercase transition-all">
                        <i class="fas fa-eraser mr-1"></i> Limpar Tudo
                    </button>
                    <div class="flex gap-3">
                        <button onclick="window.exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                            <i class="fas fa-upload"></i> Importar
                            <input type="file" id="import-file-calc" class="hidden" onchange="window.importarBackup(this)">
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 1. CUSTOS E TAXAS -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600 no-print"><i class="fas fa-file-invoice-dollar text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">1. Custos e Comiss√µes</h2>
                </div>
                
                <!-- OP√á√ÉO SHOPEE 2026 (NOVO) -->
                <div id="shopee-2026-config" class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-3">
                    <div class="flex items-center justify-between mb-2">
                         <div class="flex items-center gap-2">
                             <input type="checkbox" id="auto-shopee-2026" onchange="window.toggleAutoShopee()" class="w-4 h-4 text-orange-600 rounded focus:ring-orange-500 border-gray-300">
                             <label for="auto-shopee-2026" class="text-xs font-bold text-orange-800 uppercase cursor-pointer">Ativar Taxas Autom√°ticas 2026</label>
                         </div>
                         <span class="text-[9px] text-orange-600 font-medium">Novo</span>
                    </div>
                    
                    <div id="shopee-seller-type-container" class="hidden pl-6 mt-1">
                        <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Tipo de Vendedor</label>
                        <select id="seller-type-shopee" onchange="window.calcularGeral(false)" class="w-full px-3 py-1.5 bg-white border border-orange-200 rounded-md text-xs text-gray-700 outline-none">
                            <option value="std">Padr√£o (CNPJ / CPF < 450)</option>
                            <option value="cpf_high">CPF Alto Volume (> 450 pedidos) [+R$ 3,00]</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Custo Produto (R$)</label>
                        <input type="number" id="custo" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Extras (Embalagem) (R$)</label>
                        <input type="number" id="extra" value="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Fixa Shopee (R$)</label>
                        <input type="number" id="taxa-fixa" value="4.00" step="0.50" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Comiss√£o (%)</label>
                        <input type="number" id="comissao" value="20" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Imposto (%)</label>
                        <input type="number" id="imposto" value="4" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                </div>

                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-level-down-alt text-red-500 no-print"></i>
                        <span class="text-xs font-bold text-red-700 uppercase">Descontos & Perdas</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">1¬∫ Oferta Rel√¢mpago (%)</label>
                            <input type="number" id="desc-relampago" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">2¬∫ Cupom Loja (%)</label>
                            <input type="number" id="desc-cupom" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <div class="space-y-1 col-span-2">
                            <label class="text-[9px] font-bold text-red-400 uppercase">3¬∫ Est. Devolu√ß√£o (%)</label>
                            <input type="number" id="devolucao" value="0" step="0.1" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none" placeholder="Ex: 3%">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 relative mt-6 no-print">
                    <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded no-print">Definir Margem no Pre√ßo Final</div>
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <span class="text-xs font-bold text-blue-800">Margem L√≠quida Alvo</span>
                        <span id="label-margem" class="text-lg font-black text-blue-600">15%</span>
                    </div>
                    <input type="range" id="margem-slider" min="5" max="50" value="15" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <div class="grid grid-cols-2 gap-4 mt-5 pt-4 border-t border-blue-200">
                        <div>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mb-1">Pre√ßo Base (Sem Descontos)</span>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-blue-500 text-xs font-bold">R$</span>
                                <input type="number" id="preco-venda" step="0.01" class="w-full pl-8 pr-2 py-2 bg-white border border-blue-200 rounded-lg text-xl font-black text-blue-900 focus:outline-none focus:border-blue-500 shadow-sm">
                            </div>
                        </div>
                        <div class="text-right flex flex-col justify-center">
                            <span class="block text-[9px] font-bold text-gray-500 uppercase">Pre√ßo Final (Calculado)</span>
                            <span id="preco-final-display" class="text-sm font-bold text-gray-700">R$ 0,00</span>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mt-1">Lucro L√≠quido Real</span>
                            <span id="lucro-real" class="text-xl font-black text-green-600">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ADS ESTRAT√âGIA -->
            <div class="space-y-4 no-print">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600 no-print"><i class="fas fa-bullseye text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">2. Estrat√©gia de Ads</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Seletor de Modo -->
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Base de C√°lculo</label>
                        <select id="ads-mode" onchange="window.toggleAdsMode(); window.calcularGeral(false);" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-700 focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="cpc">Tenho o CPC (R$)</option>
                            <option value="conv">Tenho a Convers√£o (%)</option>
                            <option value="none">Sem dados (Simular M√≠nimos)</option>
                        </select>
                    </div>
                    
                    <!-- Campo Din√¢mico (CPC ou Convers√£o) -->
                    <div class="space-y-1" id="ads-input-container">
                        <label id="lbl-ads-input" class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">CPC Estimado (R$)</label>
                        <input type="number" id="ads-input" value="0.11" step="0.01" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    
                    <!-- Perfil -->
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Perfil de Investimento</label>
                        <select id="perfil-ads" onchange="window.toggleAdsProfile(); window.calcularGeral(false)" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="0.5" selected>‚öñÔ∏è Equilibrado (Min 50% Lucro)</option>
                            <option value="0.75">üöÄ Agressivo (75% Lucro)</option>
                            <option value="0.95">üëë Domina√ß√£o (95% Lucro)</option>
                            <option value="0">üå± Sem Ads (100% Lucro)</option>
                            <option value="custom">üéØ Definir CPA M√°ximo (R$)</option>
                        </select>
                    </div>

                    <div id="custom-cpa-container" class="hidden col-span-2 space-y-1 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                        <label class="text-[10px] font-bold text-yellow-700 uppercase tracking-wide">Quanto quer gastar por venda? (R$)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-yellow-600 text-xs font-bold">R$</span>
                            <input type="number" id="custom-cpa" value="10.00" step="0.50" class="w-full pl-8 pr-3 py-2 bg-white border border-yellow-300 rounded-lg text-sm font-bold text-yellow-900 focus:outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS -->
            <div id="results-area" class="space-y-6 animate-fade-in border-t-2 border-dashed border-gray-200 pt-6">
                
                <div id="ads-metrics-wrapper">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm text-center flex flex-col justify-center">
                            <span class="block text-[9px] uppercase font-bold text-gray-400 mb-1">Breakeven (Zero a Zero)</span>
                            <span id="res-roas-breakeven" class="text-xl font-black text-gray-600">ROAS: 0.00</span>
                            <span id="res-acos-breakeven" class="block text-[10px] font-bold text-gray-400 mt-1">ACOS: 0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-xl border border-green-200 shadow-sm text-center relative flex flex-col justify-center">
                            <div class="absolute -top-2 -right-2 bg-green-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold no-print">META</div>
                            <span class="block text-[9px] uppercase font-bold text-green-600 mb-1">Ideal (Meta)</span>
                            <span id="res-roas-ideal" class="text-2xl font-black text-green-600">ROAS: 0.00</span>
                            <span id="res-acos-ideal" class="block text-[10px] font-bold text-green-600 mt-1">ACOS: 0%</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm text-center">
                            <span class="block text-[10px] uppercase font-bold text-purple-600 mb-1">Custo por Convers√£o (CPA)</span>
                            <span id="res-cpa" class="text-xl font-black text-purple-700">R$ 0,00</span>
                            <span id="res-cpa-restante" class="block text-[10px] font-bold text-gray-400 mt-1">Sobra: R$ 0,00</span>
                        </div>
                        <!-- CARD DIN√ÇMICO -->
                        <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 shadow-sm text-center">
                            <span id="lbl-res-secondary" class="block text-[10px] uppercase font-bold text-orange-600 mb-1">Taxa de Convers√£o M√≠nima</span>
                            <span id="res-secondary-val" class="text-2xl font-black text-orange-600">0.00%</span>
                            <span id="res-secondary-sub" class="block text-[10px] font-bold text-orange-500 mt-1">Custo: R$ 0,00</span>
                        </div>
                    </div>

                    <div id="veredito-container" class="p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 bg-gray-50 border-gray-300 mt-4">
                        <div id="veredito-icon" class="text-2xl mt-1 text-gray-400"><i class="fas fa-info-circle"></i></div>
                        <div>
                            <h3 id="veredito-titulo" class="font-bold text-sm uppercase text-gray-700">Aguardando...</h3>
                            <p id="veredito-texto" class="text-xs text-gray-600 mt-1">Preencha os dados.</p>
                        </div>
                    </div>
                </div>

                <!-- CONTAINER DE SIMULA√á√ÉO DE OFERTA (CUSTOM + TABELA) -->
                <div id="organic-simulation-wrapper" class="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-yellow-200">
                        <i class="fas fa-bolt text-yellow-600 text-sm"></i>
                        <h2 class="text-sm font-bold text-yellow-700 uppercase">Simula√ß√£o de Oferta Rel√¢mpago (+1% a +10%)</h2>
                    </div>
                    
                    <!-- INPUT DE SIMULA√á√ÉO PERSONALIZADA -->
                    <div class="mb-4 bg-white p-3 rounded-lg border border-yellow-100 flex items-center justify-between shadow-sm">
                        <div>
                             <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Teste um Desconto (%)</label>
                             <input type="number" id="sim-custom-pct" placeholder="Ex: 50" class="w-24 px-3 py-1 bg-yellow-50 border border-yellow-300 rounded text-center font-black text-yellow-800 outline-none focus:ring-2 focus:ring-yellow-400" oninput="window.simularDescontoPersonalizado()">
                        </div>
                        <div class="text-right flex gap-4 text-xs">
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Novo Pre√ßo</span>
                                 <span id="sim-custom-price" class="font-bold text-gray-700">R$ 0,00</span>
                             </div>
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Lucro L√≠q.</span>
                                 <span id="sim-custom-profit" class="font-bold">R$ 0,00</span>
                             </div>
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Margem</span>
                                 <span id="sim-custom-margin" class="font-bold">0%</span>
                             </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse bg-white rounded-lg overflow-hidden border border-gray-200">
                            <thead class="bg-gray-50 text-[10px] text-gray-500 uppercase">
                                <tr>
                                    <th class="px-3 py-2 text-center">Desc. Total</th>
                                    <th class="px-3 py-2 text-right">Novo Pre√ßo</th>
                                    <th class="px-3 py-2 text-right">Lucro L√≠q.</th>
                                    <th class="px-3 py-2 text-center">Margem</th>
                                </tr>
                            </thead>
                            <tbody id="organic-simulation-body" class="text-xs">
                                <!-- JS Populates -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-[8px] text-yellow-600 mt-2 text-center italic">*Esta simula√ß√£o n√£o altera os dados salvos do produto acima.</p>
                </div>

                <div class="space-y-3 mt-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="bg-blue-100 p-1 rounded text-blue-600 no-print"><i class="fas fa-list-ol text-xs"></i></div>
                        <h4 class="text-xs font-bold text-gray-700 uppercase">Prova Real (Detalhamento)</h4>
                    </div>
                    <div id="breakdown-container" class="bg-gray-50 p-5 rounded-xl border border-gray-200 text-sm space-y-3 font-mono">
                        <!-- JS preenche aqui -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ABA AN√ÅLISE ADS (NOVA) -->
        <div id="view-ads-analysis" class="hidden p-6 md:p-8 space-y-8 animate-fade-in">
             <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                <div class="bg-purple-100 p-1.5 rounded-lg text-purple-600 no-print"><i class="fas fa-microscope text-sm"></i></div>
                <h2 class="text-sm font-bold text-gray-700 uppercase">Diagn√≥stico de Campanha Real</h2>
            </div>
            
            <!-- SELETOR DE PRODUTO -->
            <div class="bg-purple-50 border border-purple-200 p-3 rounded-xl mb-4 no-print">
                <label class="text-[10px] font-bold text-purple-700 uppercase tracking-wide block mb-1">Selecionar Produto Cadastrado</label>
                <div class="relative">
                    <select id="ads-saved-products" onchange="window.carregarProdutoAds(this.value)" class="w-full px-3 py-2 bg-white border border-purple-300 rounded-lg text-sm font-bold text-purple-900 outline-none cursor-pointer appearance-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- Selecione para comparar --</option>
                    </select>
                    <div class="absolute right-3 top-2.5 pointer-events-none text-purple-500"><i class="fas fa-chevron-down text-xs"></i></div>
                </div>
                <div id="ads-product-info" class="hidden mt-3 pt-3 border-t border-purple-200 grid grid-cols-3 gap-2 text-center">
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Margem Real</span>
                        <span id="ads-info-margin" class="text-xs font-black text-purple-900">0%</span>
                    </div>
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Lucro Unit.</span>
                        <span id="ads-info-profit" class="text-xs font-black text-purple-900">R$ 0,00</span>
                    </div>
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Breakeven ROAS</span>
                        <span id="ads-info-roas" class="text-xs font-black text-purple-900">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Inputs da Campanha -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Impress√µes</label>
                    <input type="number" id="camp-impressions" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="window.analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Cliques</label>
                    <input type="number" id="camp-clicks" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="window.analisarCampanha()">
                </div>
                 <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Investimento (R$)</label>
                    <input type="number" id="camp-expense" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-red-500 focus:outline-none focus:border-red-500" oninput="window.analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">GMV (Receita R$)</label>
                    <input type="number" id="camp-gmv" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-green-600 focus:outline-none focus:border-green-500" oninput="window.analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Convers√µes</label>
                    <input type="number" id="camp-conversions" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="window.analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Itens Vendidos</label>
                    <input type="number" id="camp-items" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="window.analisarCampanha()">
                </div>
            </div>

            <!-- Resultados da An√°lise -->
            <div id="camp-results" class="hidden space-y-6">
                <!-- COMP TABLE (ADDED HERE) -->
                <div id="comp-analysis-container" class="hidden bg-white border border-gray-300 rounded-xl overflow-hidden">
                     <table class="w-full text-sm text-left">
                         <thead class="bg-gray-100 text-xs text-gray-600 uppercase"><tr><th class="px-4 py-2">M√©trica</th><th class="px-4 py-2">Meta</th><th class="px-4 py-2">Real</th><th class="px-4 py-2 text-center">A√ß√£o Recomendada</th></tr></thead>
                         <tbody id="comp-analysis-body" class="divide-y divide-gray-100"></tbody>
                     </table>
                     <div id="comp-diagnostic-text" class="p-4 bg-yellow-50 text-xs text-yellow-800 font-medium border-t border-gray-200"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center flex flex-col justify-center">
                        <span class="block text-[10px] font-bold text-blue-800 uppercase mb-1">ROAS Obtido</span>
                        <span id="res-camp-roas" class="text-3xl font-black text-blue-900">0.00</span>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-200 text-center flex flex-col justify-center">
                        <span class="block text-[10px] font-bold text-purple-800 uppercase mb-1">ACOS (Custo/Venda %)</span>
                        <span id="res-camp-acos" class="text-3xl font-black text-purple-900">0.0%</span>
                    </div>
                </div>
                <div id="camp-profit-box" class="bg-gray-100 border border-gray-300 p-4 rounded-xl text-center hidden"><span class="block text-[10px] font-bold text-gray-500 uppercase">Lucro L√≠quido Campanha</span><span id="res-camp-profit" class="text-2xl font-black text-gray-800">R$ 0,00</span><p id="res-camp-profit-desc" class="text-[9px] text-gray-400 mt-1"></p></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">CTR</span><span id="res-camp-ctr" class="text-lg font-bold">0%</span></div>
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Taxa Convers√£o</span><span id="res-camp-cr" class="text-lg font-bold">0%</span></div>
                     <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Custo p/ Convers√£o</span><span id="res-camp-cpa" class="text-lg font-bold">R$ 0</span></div>
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Custo p/ Clique (CPC)</span><span id="res-camp-cpc" class="text-lg font-bold">R$ 0</span></div>
                </div>
                <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Itens Vendidos</span><span id="res-camp-items" class="text-lg font-bold text-gray-700">0</span></div>
                <div class="bg-gray-50 border-l-4 border-gray-400 p-4 rounded-r-xl"><h4 class="text-xs font-bold text-gray-700 uppercase mb-1">Diagn√≥stico R√°pido</h4><p id="camp-verdict" class="text-xs text-gray-600 leading-relaxed">-</p></div>
                
                <!-- BARRA DE A√á√ïES AN√ÅLISE ADS -->
                <div class="action-bar flex justify-end gap-3 mt-4 pt-3 border-t border-gray-200 no-print">
                    <button onclick="window.imprimirRelatorio('ads')" class="text-[10px] font-bold text-gray-600 hover:text-gray-800 flex items-center gap-1 uppercase">
                        <i class="fas fa-print"></i> Imprimir Diagn√≥stico
                    </button>
                    <button onclick="window.exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                        <i class="fas fa-upload"></i> Importar
                        <input type="file" id="import-file-ads" class="hidden" onchange="window.importarBackup(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- ABA DASHBOARD -->
        <div id="view-dash" class="hidden p-6 md:p-8 animate-fade-in">
            <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-700">Portf√≥lio de Produtos</h3><span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-mono" id="dash-count">0 produtos</span></div>
            
            <!-- Search Box -->
            <div class="mb-4 relative" id="dash-search-container">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="dash-search" placeholder="Buscar produto..." class="w-full py-2 pl-10 pr-4 bg-white border border-gray-200 rounded-xl text-sm font-bold text-gray-700 outline-none focus:border-orange-500 transition-all" oninput="window.updateDashboardTable()">
            </div>

            <div class="overflow-x-auto table-scroll">
                <table class="w-full text-left border-collapse">
                    <thead><tr class="text-[10px] uppercase text-gray-400 border-b border-gray-200"><th class="py-2 pl-2">Produto</th><th class="py-2">Pre√ßo</th><th class="py-2">Custo</th><th class="py-2">Lucro</th><th class="py-2 text-center">Margem</th><th class="py-2 pr-2 text-right"></th></tr></thead>
                    <tbody id="dash-tbody" class="text-sm"></tbody>
                </table>
            </div>

            <!-- BARRA DE A√á√ïES DASHBOARD -->
            <div class="action-bar flex justify-end gap-3 mt-4 pt-3 border-t border-gray-200 no-print">
                <button onclick="window.imprimirRelatorio('dash')" class="text-[10px] font-bold text-gray-600 hover:text-gray-800 flex items-center gap-1 uppercase">
                    <i class="fas fa-print"></i> Imprimir Portfolio
                </button>
                <button onclick="window.exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                    <i class="fas fa-upload"></i> Importar
                    <input type="file" id="import-file-dash" class="hidden" onchange="window.importarBackup(this)">
                </label>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 text-center border-t border-gray-100 no-print">
            <p class="text-[10px] text-gray-400">¬© 2024 Velt.AI | CPC M√≠nimo Shopee: R$ 0,11.</p>
        </div>

    </div>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. CONFIGURA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyA1oGBZhcHQDcDxUqCc_UrRDA4gt_yf5Os",
        authDomain: "calculadora-shopee-v2.firebaseapp.com",
        projectId: "calculadora-shopee-v2",
        storageBucket: "calculadora-shopee-v2.firebasestorage.app",
        messagingSenderId: "68009609811",
        appId: "1:68009609811:web:80bb87c668ffd54b0b54a6"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables accessible to window
    window.currentUser = null;
    window.productsCache = {};
    window.selectedAdsProduct = null;

    // Helper functions global
    window.getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
    
    window.safeSetText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };

    // Vari√°veis Globais de Elementos (Definidas no topo para garantir acesso)
    let margemSlider = null;
    
    // DEFINI√á√ÉO DAS FUN√á√ïES AUXILIARES - ATRIBUI√á√ÉO DIRETA AO WINDOW
    
    // NOTE: setVeredito only declared ONCE here
    window.setVeredito = function(color, title, desc) {
        const cont = document.getElementById('veredito-container');
        const icon = document.getElementById('veredito-icon');
        const tit = document.getElementById('veredito-titulo');
        const txt = document.getElementById('veredito-texto');
        if (!cont || !icon || !tit || !txt) return;

        const colors = { red: ['border-red-500', 'bg-red-50', 'text-red-500'], green: ['border-green-500', 'bg-green-50', 'text-green-500'], blue: ['border-blue-500', 'bg-blue-50', 'text-blue-500'] };
        const c = colors[color];
        cont.className = `p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 ${c[1]} ${c[0]}`;
        icon.className = `text-2xl mt-1 ${c[2]}`;
        icon.innerHTML = color === 'red' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-check-circle"></i>';
        tit.innerText = title; tit.className = `font-bold text-sm uppercase ${c[2]}`; txt.innerText = desc;
    };

    window.checkVereditoConv = function(lucroUnit, convMin) {
        if (lucroUnit <= 0) window.setVeredito('red', 'PREJU√çZO', 'Margem negativa.');
        else if (convMin > 3.0) window.setVeredito('red', 'DIF√çCIL', `Precisa de ${convMin.toFixed(1)}% conv.`);
        else if (convMin < 1.0) window.setVeredito('green', 'MUITO VI√ÅVEL', `Meta f√°cil: ${convMin.toFixed(1)}%.`);
        else window.setVeredito('blue', 'VI√ÅVEL', `Meta de ${convMin.toFixed(1)}% ok.`);
    };

    window.checkVereditoCPC = function(lucroUnit, cpcMax) {
        if (lucroUnit <= 0) window.setVeredito('red', 'PREJU√çZO', 'Margem negativa.');
        else if (cpcMax < 0.11) window.setVeredito('red', 'INVI√ÅVEL', `Teto R$ ${cpcMax.toFixed(2)} < M√≠nimo.`);
        else window.setVeredito('blue', 'VI√ÅVEL', `Teto de R$ ${cpcMax.toFixed(2)} ok.`);
    };

    window.checkVereditoOrganic = function(lucroUnit) {
        window.setVeredito(lucroUnit <= 0 ? 'red' : 'green', lucroUnit <= 0 ? 'PREJU√çZO' : 'LUCRO ORG√ÇNICO', lucroUnit <= 0 ? 'Margem negativa.' : 'Sem custos de ads.');
    };
    
    window.calcularPrecoFinal = function(precoBase) {
        const descCupom = window.getVal('desc-cupom') / 100;
        const descRelampago = window.getVal('desc-relampago') / 100;
        const aposRelampago = precoBase * (1 - descRelampago);
        return aposRelampago * (1 - descCupom);
    };
    
    window.toggleAutoShopee = function() {
        const isAuto = document.getElementById('auto-shopee-2026').checked;
        const inputs = ['comissao', 'taxa-fixa'];
        const configContainer = document.getElementById('shopee-seller-type-container');

        if(isAuto) {
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = true;
                el.classList.add('bg-gray-100', 'text-gray-500');
            });
            configContainer.classList.remove('hidden');
            window.calcularGeral(false);
        } else {
            inputs.forEach(id => {
                const el = document.getElementById(id);
                el.readOnly = false;
                el.classList.remove('bg-gray-100', 'text-gray-500');
            });
            configContainer.classList.add('hidden');
        }
    };
    
    window.calcularTaxasShopee = function() {
        if (!document.getElementById('auto-shopee-2026').checked) return;

        const preco = parseFloat(document.getElementById('preco-final-display').innerText.replace('R$ ', '').replace(',', '.')) || 0;
        const tipoVendedor = document.getElementById('seller-type-shopee').value;
        let pct = 0;
        let fixa = 0;

        // Tiers Logic (Baseada no pre√ßo FINAL de venda)
        // Corre√ß√£o: A regra da Shopee se aplica ao valor pago pelo comprador, ent√£o usamos o pre√ßo final calculado
        // Mas para evitar loop infinito na precifica√ß√£o baseada em margem, usamos uma aproxima√ß√£o baseada no Pre√ßo Venda Base se o Final for 0
        let refPrice = preco > 0 ? preco : window.getVal('preco-venda');

        if (refPrice < 80) { pct = 20; fixa = 4; }
        else if (refPrice < 100) { pct = 14; fixa = 16; }
        else if (refPrice < 200) { pct = 14; fixa = 20; }
        else { pct = 14; fixa = 26; }

        // Low price rule
        if (refPrice < 8) { fixa = refPrice / 2; } 

        // CPF High Volume rule
        if (tipoVendedor === 'cpf_high') { fixa += 3; }

        // Update DOM without triggering endless loop
        const elComissao = document.getElementById('comissao');
        const elFixa = document.getElementById('taxa-fixa');
        
        if(elComissao.value != pct) elComissao.value = pct;
        if(elFixa.value != fixa.toFixed(2)) elFixa.value = fixa.toFixed(2);
    };
    
    window.renderizarSimulacaoOrganica = function(precoBase, custo, extra, fixo) { 
        const descCupom = window.getVal('desc-cupom') / 100;
        const descRelampagoBase = window.getVal('desc-relampago'); 
        const comissao = window.getVal('comissao') / 100;
        const imposto = window.getVal('imposto') / 100;
        const devolucao = window.getVal('devolucao') / 100;
        const fixedCosts = custo + extra + fixo;

        let html = '';
        for(let i = 1; i <= 10; i++) {
            const simDescPct = descRelampagoBase + i; 
            const simDescDecimal = simDescPct / 100;
            const priceOffer = precoBase * (1 - simDescDecimal);
            const priceFinal = priceOffer * (1 - descCupom);
            const totalTaxVal = priceFinal * (comissao + imposto + devolucao);
            const profit = priceFinal - fixedCosts - totalTaxVal;
            const margin = priceFinal > 0 ? (profit / priceFinal) * 100 : 0;
            const profitClass = profit >= 0 ? "text-green-600" : "text-red-600";
            const marginClass = margin > 0 ? "bg-green-50 text-green-800" : "bg-red-50 text-red-800";

            html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-3 py-2 text-center text-gray-700 font-bold">${simDescPct.toFixed(0)}%</td>
                <td class="px-3 py-2 text-right text-gray-600">R$ ${priceFinal.toFixed(2)}</td>
                <td class="px-3 py-2 text-right font-bold ${profitClass}">R$ ${profit.toFixed(2)}</td>
                <td class="px-3 py-2 text-center">
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold ${marginClass}">${margin.toFixed(1)}%</span>
                </td>
            </tr>`;
        }
        const tbody = document.getElementById('organic-simulation-body');
        if(tbody) tbody.innerHTML = html;
        const wrapper = document.getElementById('organic-simulation-wrapper');
        if(wrapper) wrapper.classList.remove('hidden');
    };

    window.simularDescontoPersonalizado = function() {
        const inputVal = parseFloat(document.getElementById('sim-custom-pct').value) || 0;
        const precoBase = window.getVal('preco-venda');
        const descCupom = window.getVal('desc-cupom') / 100;
        const simDescDecimal = inputVal / 100;
        const priceOffer = precoBase * (1 - simDescDecimal);
        const priceFinal = priceOffer * (1 - descCupom);
        const custo = window.getVal('custo');
        const extra = window.getVal('extra');
        const fixo = window.getVal('taxa-fixa');
        const comissao = window.getVal('comissao') / 100;
        const imposto = window.getVal('imposto') / 100;
        const devolucao = window.getVal('devolucao') / 100;
        const totalTaxVal = priceFinal * (comissao + imposto + devolucao);
        const profit = priceFinal - (custo + extra + fixo) - totalTaxVal;
        const margin = priceFinal > 0 ? (profit / priceFinal) * 100 : 0;
        window.safeSetText('sim-custom-price', "R$ " + priceFinal.toFixed(2));
        const profitEl = document.getElementById('sim-custom-profit');
        if(profitEl) {
            profitEl.innerText = "R$ " + profit.toFixed(2);
            profitEl.className = profit >= 0 ? "font-bold text-green-600" : "font-bold text-red-600";
        }
        window.safeSetText('sim-custom-margin', margin.toFixed(1) + "%");
    };

    window.renderizarProvaReal = function(precoBase, custo, extra, fixo, customRelampagoPct = null) {
        const descCupom = window.getVal('desc-cupom'); 
        
        // Use custom percentage if provided (from simulation), otherwise use saved input value
        let descRelampago = 0;
        if (customRelampagoPct !== null) {
             descRelampago = customRelampagoPct;
        } else {
             descRelampago = window.getVal('desc-relampago') / 100;
        }

        const comissao = window.getVal('comissao'); const imposto = window.getVal('imposto'); const devolucao = window.getVal('devolucao');
        
        const valDescRelampago = precoBase * descRelampago; 
        const precoAposRelampago = precoBase - valDescRelampago;
        const valDescCupom = precoAposRelampago * (descCupom / 100); 
        const precoFinal = precoAposRelampago - valDescCupom;
        
        const valComissao = precoFinal * (comissao / 100); 
        const valImposto = precoFinal * (imposto / 100); 
        const valDevolucao = precoFinal * (devolucao / 100);
        
        const custoTotal = custo + extra + fixo + valComissao + valImposto + valDevolucao; 
        const lucroFinal = precoFinal - custoTotal;
        
        const margemFinal = precoFinal > 0 ? (lucroFinal / precoFinal) * 100 : 0;
        
        const container = document.getElementById('breakdown-container');
        if (!container) return;

        const row = (lbl, pct, val, clr) => `<div class="flex justify-between items-center"><span class="${clr}">${lbl} ${pct?`(${pct}%)`:''}</span><span class="${clr}">${val < 0 ? '-' : ''} R$ ${Math.abs(val).toFixed(2)}</span></div>`;
        
        container.innerHTML = `
            ${row('Pre√ßo de Venda (Base)', null, precoBase, 'font-bold text-gray-800')}
            ${descRelampago > 0 ? row('(-) Oferta Rel√¢mpago', (descRelampago*100).toFixed(0), -valDescRelampago, 'text-red-500') : ''}
            ${descCupom > 0 ? row('(-) Cupom Loja', (descCupom*100).toFixed(0), -valDescCupom, 'text-red-500') : ''}
            <div class="border-t border-dashed border-gray-300 my-2"></div>
            ${row('(=) Pre√ßo Venda (Nota Fiscal)', null, precoFinal, 'font-bold text-blue-800')}
            ${devolucao > 0 ? row('(-) Devolu√ß√£o Estimada', (devolucao*100).toFixed(1), -valDevolucao, 'text-red-500 font-bold') : ''}
            ${row('(-) Custo do Produto', null, -custo, 'text-red-400')}
            ${row('(-) Custos Extras', null, -extra, 'text-red-400')}
            ${row('(-) Taxa Fixa Shopee', null, -fixo, 'text-red-400')}
            ${row('(-) Comiss√£o Shopee', (comissao*100).toFixed(0), -valComissao, 'text-red-400')}
            ${row('(-) Impostos', (imposto*100).toFixed(0), -valImposto, 'text-red-400')}
            <div class="border-t border-gray-300 mt-2 pt-2 flex justify-between font-black ${lucroFinal>=0?'text-green-600':'text-red-600'}">
                <span>(=) LUCRO L√çQUIDO FINAL</span><span>R$ ${lucroFinal.toFixed(2)}</span>
            </div>
            <div class="text-right text-[10px] text-gray-400">Margem Real: ${((lucroFinal/precoFinal)*100).toFixed(2)}%</div>
        `;
    }

    window.carregarProdutoAds = function(id) {
        if (!id || !window.productsCache[id]) { window.selectedAdsProduct = null; document.getElementById('ads-product-info').classList.add('hidden'); return; }
        const p = window.productsCache[id];
        const pBase = parseFloat(p.precoVenda)||0; const custo = parseFloat(p.custo)||0; const extra = parseFloat(p.extra)||0; const fixo = parseFloat(p.taxaFixa)||0;
        const descC = (parseFloat(p.descCupom)||0)/100; const descR = (parseFloat(p.descRelampago)||0)/100;
        const pFinal = (pBase * (1-descR)) * (1-descC);
        const comissao = (parseFloat(p.comissao)||0)/100; const imposto = (parseFloat(p.imposto)||0)/100; const devolucao = (parseFloat(p.devolucao)||0)/100;
        const taxasTotal = pFinal * (comissao + imposto + devolucao);
        const lucroUnit = pFinal - custo - extra - fixo - taxasTotal;
        const margem = pFinal > 0 ? (lucroUnit / pFinal) * 100 : 0;
        const targetCpa = (p.perfilAds === 'custom') ? (parseFloat(p.customCpa)||0) : (p.perfilAds == 0 ? 0 : Math.max(lucroUnit * 0.5, lucroUnit * parseFloat(p.perfilAds||0.5)));
        const targetRoas = targetCpa > 0 ? (pFinal / targetCpa) : 0;
        
        window.selectedAdsProduct = { name: p.name, lucroUnit: lucroUnit, margem: margem, targetRoas: targetRoas, targetCpa: targetCpa };
        
        window.safeSetText('ads-info-margin', margem.toFixed(1) + "%");
        window.safeSetText('ads-info-profit', "R$ " + lucroUnit.toFixed(2));
        window.safeSetText('ads-info-roas', targetRoas.toFixed(2));
        document.getElementById('ads-product-info').classList.remove('hidden');
        analisarCampanha();
    };

    window.analisarCampanha = function() {
        const impress = window.getVal('camp-impressions'); const clicks = window.getVal('camp-clicks'); const expense = window.getVal('camp-expense');
        const gmv = window.getVal('camp-gmv'); const conversions = window.getVal('camp-conversions'); const items = window.getVal('camp-items');
        const resultDiv = document.getElementById('camp-results');
        
        if(!resultDiv) return;
        if(clicks === 0 && expense === 0) { resultDiv.classList.add('hidden'); return; }
        resultDiv.classList.remove('hidden');

        const roas = expense > 0 ? (gmv / expense) : 0;
        const acos = gmv > 0 ? (expense / gmv) * 100 : 0;
        const ctr = impress > 0 ? (clicks / impress) * 100 : 0;
        const cr = clicks > 0 ? (conversions / clicks) * 100 : 0;
        const cpa = conversions > 0 ? (expense / conversions) : 0;
        const cpc = clicks > 0 ? (expense / clicks) : 0;

        window.safeSetText('res-camp-roas', roas.toFixed(2));
        window.safeSetText('res-camp-acos', acos.toFixed(1) + "%");
        window.safeSetText('res-camp-ctr', ctr.toFixed(2) + "%");
        window.safeSetText('res-camp-cr', cr.toFixed(2) + "%");
        window.safeSetText('res-camp-cpa', "R$ " + cpa.toFixed(2));
        window.safeSetText('res-camp-cpc', "R$ " + cpc.toFixed(2));
        window.safeSetText('res-camp-items', items);

        const profitBox = document.getElementById('camp-profit-box');
        const compTable = document.getElementById('comp-analysis-container');
        const compBody = document.getElementById('comp-analysis-body');
        const diagText = document.getElementById('comp-diagnostic-text');
        const verdictEl = document.getElementById('camp-verdict');

        if (window.selectedAdsProduct) {
            const quantitySold = items > 0 ? items : conversions;
            const netCampaignProfit = (quantitySold * window.selectedAdsProduct.lucroUnit) - expense;
            
            const profitEl = document.getElementById('res-camp-profit');
            if (profitEl) {
                profitEl.innerText = "R$ " + netCampaignProfit.toFixed(2);
                profitEl.className = netCampaignProfit >= 0 ? "text-2xl font-black text-green-600" : "text-2xl font-black text-red-600";
            }
            window.safeSetText('res-camp-profit-desc', `${quantitySold} itens x R$ ${window.selectedAdsProduct.lucroUnit.toFixed(2)} (lucro unit) - R$ ${expense.toFixed(2)} (ads)`);
            
            if(profitBox) profitBox.classList.remove('hidden');

            const targetCpa = window.selectedAdsProduct.targetCpa;
            const targetRoas = window.selectedAdsProduct.targetRoas;
            const targetConv = targetCpa > 0 ? (cpc / targetCpa) * 100 : 0;
            const maxCpc = targetCpa * (cr / 100);

            const row = (name, target, actual, isGood, goodTxt, badTxt) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900">${name}</td>
                    <td class="px-4 py-2 text-gray-500">${target}</td>
                    <td class="px-4 py-2 font-bold ${isGood ? 'text-green-600' : 'text-red-600'}">${actual}</td>
                    <td class="px-4 py-2 text-center text-xs">
                        <span class="${isGood ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-0.5 rounded-full">
                            ${isGood ? goodTxt : badTxt}
                        </span>
                    </td>
                </tr>
            `;

            let rows = "";
            rows += row('ROAS', `> ${targetRoas.toFixed(2)}`, roas.toFixed(2), roas >= targetRoas, 'Bom', 'Baixo');
            rows += row('CPA', `< R$ ${targetCpa.toFixed(2)}`, `R$ ${cpa.toFixed(2)}`, cpa <= targetCpa, 'Bom', 'Alto');
            rows += row('CPC (Ideal)', `< R$ ${maxCpc.toFixed(2)}`, `R$ ${cpc.toFixed(2)}`, cpc <= maxCpc, 'Eficiente', 'Caro');
            rows += row('Conv. (Nec.)', `> ${targetConv.toFixed(1)}%`, `${cr.toFixed(1)}%`, cr >= targetConv, '√ìtimo', 'Baixa');

            if(compBody) compBody.innerHTML = rows;

            let diagnosis = "";
            if (cpa > targetCpa) {
                diagnosis = `<strong class="text-red-700">üî¥ AN√ÅLISE T√âCNICA: CAMPANHA INEFICIENTE</strong><br>`;
                diagnosis += `<div class="mt-2 text-gray-700 text-xs space-y-1">`;
                if (cpc > maxCpc) {
                    diagnosis += `‚Ä¢ <b>CPC Inflacionado:</b> O leil√£o est√° caro (R$ ${cpc.toFixed(2)}). Para viabilizar, seu CTR precisa subir urgente. Teste novas capas.`;
                }
                if (cr < targetConv) {
                    diagnosis += `‚Ä¢ <b>Convers√£o Cr√≠tica:</b> Apenas ${cr.toFixed(2)}% compram. O tr√°fego chega e sai. Melhore descri√ß√£o, provas sociais ou revise se o pre√ßo est√° competitivo.`;
                }
                if (acos > window.selectedAdsProduct.margem) {
                     diagnosis += `‚Ä¢ <b>ACOS Explosivo:</b> Voc√™ gasta ${acos.toFixed(1)}% da venda em ads, mas sua margem √© ${window.selectedAdsProduct.margem.toFixed(1)}%. Preju√≠zo garantido.`;
                }
                diagnosis += `</div>`;
            } else {
                diagnosis = `
                    <strong class="text-green-700">üü¢ AN√ÅLISE T√âCNICA: CAMPANHA ESCAL√ÅVEL</strong><br>
                    <div class="mt-1 text-gray-600 text-xs">
                    M√©tricas saud√°veis. O CPA (R$ ${cpa.toFixed(2)}) permite lucro. <br>
                    <b>Pr√≥ximo passo:</b> Aumente o or√ßamento di√°rio em 20% a cada 3 dias para escalar sem perder a efici√™ncia (ROAS).
                    </div>
                `;
            }
            if(diagText) diagText.innerHTML = diagnosis;
            if(compTable) compTable.classList.remove('hidden');

             if (netCampaignProfit < 0) {
                 if(verdictEl) {
                     verdictEl.innerText = `PREJU√çZO OPERACIONAL: A campanha queimou R$ ${Math.abs(netCampaignProfit).toFixed(2)}. Pause palavras-chave amplas ou reduza o teto de lance.`;
                     verdictEl.className = "text-xs text-red-600 leading-relaxed font-bold";
                 }
             } else {
                 if(verdictEl) {
                     verdictEl.innerText = "LUCRO OPERACIONAL: O produto se paga. Foque em manter o ROAS est√°vel enquanto aumenta o volume.";
                     verdictEl.className = "text-xs text-green-600 leading-relaxed font-bold";
                 }
             }

        } else {
            if(profitBox) profitBox.classList.add('hidden');
            if(compTable) compTable.classList.add('hidden');
            
            if(verdictEl) {
                if(acos > 40) {
                    verdictEl.innerText = "Aten√ß√£o Cr√≠tica: O custo do an√∫ncio est√° consumindo mais de 40% da receita. Verifique margem.";
                    verdictEl.className = "text-xs text-red-600 leading-relaxed font-bold";
                } else if (roas < 3) {
                    verdictEl.innerText = "Alerta: ROAS baixo (< 3). Cuidado com preju√≠zo.";
                    verdictEl.className = "text-xs text-orange-600 leading-relaxed font-bold";
                } else {
                     verdictEl.innerText = "Saud√°vel: M√©tricas dentro de par√¢metros aceit√°veis.";
                     verdictEl.className = "text-xs text-green-600 leading-relaxed font-bold";
                }
            }
        }
    }
    
    // Fun√ß√£o de impress√£o com nome de arquivo e escopo de aba
    window.imprimirRelatorio = function() {
        const nomeProdInput = document.getElementById('prod-name');
        let nomeProd = nomeProdInput ? (nomeProdInput.value || "Relatorio_VeltAI") : "Relatorio_VeltAI";
        
        // Ensure format just in case
        nomeProd = nomeProd.replace(/\s+/g, '_');
        if(nomeProd.length > 0) nomeProd = nomeProd.charAt(0).toUpperCase() + nomeProd.slice(1);

        // Atualiza o elemento de impress√£o com o nome
        const printTitle = document.getElementById('prod-name-print');
        if(printTitle) printTitle.innerText = nomeProd;

        // Nome do arquivo = Nome do Produto (limpo)
        const originalTitle = document.title;
        document.title = nomeProd;
        window.print();
        
        // Timeout para garantir que o dialog de impress√£o pegou o t√≠tulo alterado
        setTimeout(() => {
            document.title = originalTitle;
        }, 1000);
    }
</script>

</body>
</html>

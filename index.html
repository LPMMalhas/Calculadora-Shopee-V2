<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velt.AI - Precifica칞칚o Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .shopee-gradient { background: linear-gradient(135deg, #ee4d2d 0%, #ff7337 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        input[type=range] { accent-color: #ee4d2d; }
        input:focus { ring: 2px; ring-color: #ee4d2d; border-color: #ee4d2d; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ee4d2d; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); } 20% { transform: translate(-3px, 0px); } 30% { transform: translate(3px, 2px); } 40% { transform: translate(1px, -1px); } 50% { transform: translate(-1px, 2px); } 60% { transform: translate(-3px, 1px); } 70% { transform: translate(3px, 1px); } 80% { transform: translate(-1px, -1px); } 90% { transform: translate(1px, 2px); } 100% { transform: translate(1px, -2px); } }
    
        /* Custom Scrollbar for Table */
        .table-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col items-center justify-center py-4 md:py-8 px-4">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="w-full max-w-sm bg-white rounded-3xl overflow-hidden card-shadow p-8 transition-all">
        <div class="text-center mb-8">
            <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                <i class="fas fa-rocket text-4xl text-[#ee4d2d]"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-800">Velt.AI Cloud</h1>
            <p class="text-sm text-gray-400 mt-1">Precifica칞칚o Inteligente & Ads</p>
        </div>

        <div class="space-y-4">
            <!-- Box de Ajuda Firebase -->
            <div id="firebase-help" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-left mb-4">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                    <div>
                        <h4 class="text-xs font-bold text-yellow-800 uppercase">Configura칞칚o Necess치ria</h4>
                        <p class="text-[10px] text-yellow-700 mt-1 leading-relaxed">
                            O Firebase recusou a conex칚o. Isso 칠 normal em projetos novos.
                            <br><br>
                            1. V치 em <b>Authentication > Sign-in method</b>.<br>
                            2. Ative <b>Email/Password</b> e <b>Anonymous</b>.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">E-mail</label>
                <input type="email" id="login-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="seu@email.com">
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Senha</label>
                <input type="password" id="login-password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="********">
            </div>
            
            <div id="login-error" class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-600 text-xs text-center hidden"></div>

            <button onclick="fazerLogin()" id="btn-login" class="w-full py-3.5 shopee-gradient text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition-all">
                Entrar
            </button>
            
            <button onclick="fazerLoginAnonimo()" id="btn-guest" class="w-full py-2 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-all text-xs uppercase">
                Entrar como Convidado
            </button>
            
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-xs">ou</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <button onclick="fazerCadastro()" id="btn-register" class="w-full py-3.5 bg-white border-2 border-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition-all">
                Criar Conta Gr치tis
            </button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden w-full max-w-4xl bg-white rounded-3xl overflow-hidden card-shadow transition-all duration-300">
        
        <!-- Header -->
        <div class="shopee-gradient p-6 text-white text-center relative">
            <div class="absolute top-5 right-5 opacity-40 cursor-pointer hover:opacity-100 transition-opacity" onclick="fazerLogout()" title="Sair da Conta"><i class="fas fa-sign-out-alt text-2xl"></i></div>
            <h1 class="text-2xl font-extrabold tracking-tight">Velt.AI <span class="font-light opacity-90">| Cloud</span></h1>
            <p class="text-xs font-medium uppercase tracking-widest mt-1 opacity-90">Precifica칞칚o, Ads & Firebase</p>
        </div>

        <!-- Navega칞칚o Tabs -->
        <div class="flex border-b border-gray-200 bg-white sticky top-0 z-10">
            <button id="tab-calc" onclick="switchTab('calc')" class="flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-calculator mr-1"></i> Calculadora
            </button>
            <button id="tab-dash" onclick="switchTab('dash')" class="flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-chart-line mr-1"></i> Dashboard
            </button>
        </div>

        <!-- ABA CALCULADORA -->
        <div id="view-calc" class="p-6 md:p-8 space-y-8 animate-fade-in">

            <!-- GEST츾O DE PRODUTOS -->
            <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 md:p-5 relative">
                <div class="absolute -top-3 left-4 bg-gray-800 text-white text-[10px] font-bold px-2 py-0.5 rounded">GEST츾O DE PRODUTOS</div>
                
                <div class="flex justify-between items-center mb-3">
                    <div id="db-mode" class="text-[9px] font-bold uppercase text-gray-400">Projeto Pessoal</div>
                    <div class="text-[10px] text-right text-gray-400 flex items-center gap-2">
                        <span id="auth-status">Conectado</span>
                        <span id="badge-mode" class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]">NOVO</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3 mb-4">
                    <div class="flex-grow">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Nome do Produto</label>
                        <input type="text" id="prod-name" placeholder="Ex: Tenis_Corrida" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold outline-none focus:border-orange-500 uppercase transition-all">
                        <input type="hidden" id="prod-id">
                    </div>
                    <div class="flex items-end gap-2">
                        <button onclick="novoProduto()" class="py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-50 transition-all h-[42px]" title="Limpar Campos / Novo Produto">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="salvarProduto()" id="btn-save" class="py-2 px-6 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-bold shadow-sm transition-all flex items-center justify-center gap-2 h-[42px] min-w-[120px]">
                            <i class="fas fa-save"></i> <span id="btn-save-text">Salvar</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-end gap-2">
                    <div class="flex-grow relative">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Carregar Produto Salvo</label>
                        <select id="saved-products" onchange="carregarProduto(this.value)" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm outline-none cursor-pointer appearance-none">
                            <option value="">Selecione um produto...</option>
                        </select>
                        <div class="absolute right-3 bottom-2.5 pointer-events-none text-gray-400"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>
                    <button onclick="excluirProduto()" id="btn-delete" class="py-2 px-4 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm font-bold shadow-sm hover:bg-red-100 hover:border-red-300 transition-all h-[42px] hidden" title="Excluir Este Produto">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <div class="flex justify-end gap-3 mt-4 pt-3 border-t border-gray-200">
                    <button onclick="exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                        <i class="fas fa-download"></i> Exportar Backup
                    </button>
                    <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                        <i class="fas fa-upload"></i> Importar Backup
                        <input type="file" id="import-file" class="hidden" onchange="importarBackup(this)">
                    </label>
                </div>
            </div>
            
            <!-- 1. CUSTOS E TAXAS -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600"><i class="fas fa-file-invoice-dollar text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">1. Custos e Comiss칫es</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Custo Produto (R$)</label>
                        <input type="number" id="custo" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Extras (Embalagem) (R$)</label>
                        <input type="number" id="extra" value="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Fixa Shopee (R$)</label>
                        <input type="number" id="taxa-fixa" value="4.00" step="0.50" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Comiss칚o (%)</label>
                        <input type="number" id="comissao" value="20" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Imposto (%)</label>
                        <input type="number" id="imposto" value="4" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                </div>

                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-level-down-alt text-red-500"></i>
                        <span class="text-xs font-bold text-red-700 uppercase">Descontos & Perdas</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">1췈 Oferta Rel칙mpago (%)</label>
                            <input type="number" id="desc-relampago" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">2췈 Cupom Loja (%)</label>
                            <input type="number" id="desc-cupom" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <!-- Devolu칞칚o movida para aqui -->
                        <div class="space-y-1 col-span-2">
                            <label class="text-[9px] font-bold text-red-400 uppercase">3췈 Est. Devolu칞칚o (%)</label>
                            <input type="number" id="devolucao" value="0" step="0.1" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none" placeholder="Ex: 3%">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 relative mt-6">
                    <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded">Definir Margem no Pre칞o Final</div>
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <span class="text-xs font-bold text-blue-800">Margem L칤quida Alvo</span>
                        <span id="label-margem" class="text-lg font-black text-blue-600">15%</span>
                    </div>
                    <input type="range" id="margem-slider" min="5" max="50" value="15" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <div class="grid grid-cols-2 gap-4 mt-5 pt-4 border-t border-blue-200">
                        <div>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mb-1">Pre칞o Base (Sem Descontos)</span>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-blue-500 text-xs font-bold">R$</span>
                                <input type="number" id="preco-venda" step="0.01" class="w-full pl-8 pr-2 py-2 bg-white border border-blue-200 rounded-lg text-xl font-black text-blue-900 focus:outline-none focus:border-blue-500 shadow-sm">
                            </div>
                        </div>
                        <div class="text-right flex flex-col justify-center">
                            <span class="block text-[9px] font-bold text-gray-500 uppercase">Pre칞o Final (Calculado)</span>
                            <span id="preco-final-display" class="text-sm font-bold text-gray-700">R$ 0,00</span>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mt-1">Lucro L칤quido Real</span>
                            <span id="lucro-real" class="text-xl font-black text-green-600">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ADS ESTRAT칄GIA -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600"><i class="fas fa-bullseye text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">2. Estrat칠gia de Ads</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Seletor de Modo -->
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Base de C치lculo</label>
                        <select id="ads-mode" onchange="toggleAdsMode(); calcularGeral(false);" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-700 focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="cpc">Tenho o CPC (R$)</option>
                            <option value="conv">Tenho a Convers칚o (%)</option>
                            <option value="none">Sem dados (Simular M칤nimos)</option>
                        </select>
                    </div>
                    
                    <!-- Campo Din칙mico (CPC ou Convers칚o) -->
                    <div class="space-y-1" id="ads-input-container">
                        <label id="lbl-ads-input" class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">CPC Estimado (R$)</label>
                        <input type="number" id="ads-input" value="0.11" step="0.01" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    
                    <!-- Perfil -->
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Perfil</label>
                        <select id="perfil-ads" onchange="calcularGeral(false)" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="0.5" selected>丘뒲잺 Equilibrado (Min 50% Lucro)</option>
                            <option value="0.75">游 Agressivo (75% Lucro)</option>
                            <option value="0.95">游녬 Domina칞칚o (95% Lucro)</option>
                            <option value="0">游꺔 Sem Ads (100% Lucro)</option>
                        </select>
                    </div>
                </div>

                <button onclick="calcularGeral(true)" class="w-full py-4 bg-gray-900 text-white font-bold rounded-xl shadow-lg hover:bg-gray-800 transform active:scale-95 transition-all flex justify-center items-center gap-2 mt-4">
                    <i class="fas fa-calculator text-yellow-400"></i> CALCULAR VIABILIDADE
                </button>
            </div>

            <!-- RESULTADOS -->
            <div id="results-area" class="hidden space-y-6 animate-fade-in border-t-2 border-dashed border-gray-200 pt-6">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm text-center flex flex-col justify-center">
                        <span class="block text-[9px] uppercase font-bold text-gray-400 mb-1">Breakeven (Zero a Zero)</span>
                        <span id="res-roas-breakeven" class="text-xl font-black text-gray-600">ROAS: 0.00</span>
                        <span id="res-acos-breakeven" class="block text-[10px] font-bold text-gray-400 mt-1">ACOS: 0%</span>
                    </div>
                    <div class="bg-green-50 p-3 rounded-xl border border-green-200 shadow-sm text-center relative flex flex-col justify-center">
                        <div class="absolute -top-2 -right-2 bg-green-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold">META</div>
                        <span class="block text-[9px] uppercase font-bold text-green-600 mb-1">Ideal (Meta)</span>
                        <span id="res-roas-ideal" class="text-2xl font-black text-green-600">ROAS: 0.00</span>
                        <span id="res-acos-ideal" class="block text-[10px] font-bold text-green-600 mt-1">ACOS: 0%</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm text-center">
                        <span class="block text-[10px] uppercase font-bold text-purple-600 mb-1">Custo por Convers칚o (CPA)</span>
                        <span id="res-cpa" class="text-xl font-black text-purple-700">R$ 0,00</span>
                        <span id="res-cpa-restante" class="block text-[10px] font-bold text-gray-400 mt-1">Sobra: R$ 0,00</span>
                    </div>
                    <!-- CARD DIN츽MICO (CPC M츼X ou CONVERS츾O M칈N) -->
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 shadow-sm text-center">
                        <span id="lbl-res-secondary" class="block text-[10px] uppercase font-bold text-orange-600 mb-1">Taxa de Convers칚o M칤nima</span>
                        <span id="res-secondary-val" class="text-2xl font-black text-orange-600">0.00%</span>
                        <span id="res-secondary-sub" class="block text-[10px] font-bold text-orange-500 mt-1">Custo: R$ 0,00</span>
                    </div>
                </div>

                <div id="veredito-container" class="p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 bg-gray-50 border-gray-300">
                    <div id="veredito-icon" class="text-2xl mt-1 text-gray-400"><i class="fas fa-info-circle"></i></div>
                    <div>
                        <h3 id="veredito-titulo" class="font-bold text-sm uppercase text-gray-700">Aguardando...</h3>
                        <p id="veredito-texto" class="text-xs text-gray-600 mt-1">Preencha os dados.</p>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="bg-blue-100 p-1 rounded text-blue-600"><i class="fas fa-list-ol text-xs"></i></div>
                        <h4 class="text-xs font-bold text-gray-700 uppercase">Prova Real (Detalhamento)</h4>
                    </div>
                    <div id="breakdown-container" class="bg-gray-50 p-5 rounded-xl border border-gray-200 text-sm space-y-3 font-mono">
                        <!-- JS preenche aqui -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ABA DASHBOARD -->
        <div id="view-dash" class="hidden p-6 md:p-8 animate-fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg text-gray-700">Portf칩lio de Produtos</h3>
                <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-mono" id="dash-count">0 produtos</span>
            </div>

            <div class="overflow-x-auto table-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] uppercase text-gray-400 border-b border-gray-200">
                            <th class="py-2 pl-2">Produto</th>
                            <th class="py-2">Pre칞o Final</th>
                            <th class="py-2">Custo</th>
                            <th class="py-2">Lucro L칤q.</th>
                            <th class="py-2 text-center">Margem %</th>
                            <th class="py-2 pr-2 text-right">A칞칚o</th>
                        </tr>
                    </thead>
                    <tbody id="dash-tbody" class="text-sm">
                        <tr><td colspan="6" class="text-center py-8 text-gray-400">Carregando produtos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 text-center border-t border-gray-100">
            <p class="text-[10px] text-gray-400">춸 2024 Velt.AI | CPC M칤nimo Shopee: R$ 0,11.</p>
        </div>

    </div>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. CONFIGURA칂츾O FIREBASE (Projeto do Usu치rio)
    const firebaseConfig = {
        apiKey: "AIzaSyA1oGBZhcHQDcDxUqCc_UrRDA4gt_yf5Os",
        authDomain: "calculadora-shopee-v2.firebaseapp.com",
        projectId: "calculadora-shopee-v2",
        storageBucket: "calculadora-shopee-v2.firebasestorage.app",
        messagingSenderId: "68009609811",
        appId: "1:68009609811:web:80bb87c668ffd54b0b54a6"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let productsCache = {};

    // 2. AUTH SYSTEM
    const initAuth = async () => {
        // Nada autom치tico
    };
    initAuth();

    onAuthStateChanged(auth, (user) => {
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        
        if (user) {
            currentUser = user;
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            let displayName = user.email ? user.email.split('@')[0] : 'Convidado';
            document.getElementById('auth-status').innerText = `${displayName}`;
            document.getElementById('auth-status').classList.add("text-green-500");
            initFirestoreListener();
        } else {
            currentUser = null;
            loginScreen.classList.remove('hidden');
            appContent.classList.add('hidden');
            document.getElementById('auth-status').innerText = "Desconectado";
        }
    });

    window.fazerLogin = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-login');

        if (!email || !pass) return showError("Preencha e-mail e senha.");

        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;
        document.getElementById('login-error').classList.add('hidden');

        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            console.error(error);
            handleAuthError(error);
            btn.innerText = "Entrar";
            btn.disabled = false;
        }
    };

    window.fazerCadastro = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-register');
        
        if (!email || !pass) return showError("Preencha e-mail e senha para cadastrar.");
        if (pass.length < 6) return showError("Senha deve ter min. 6 caracteres.");

        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;

        try {
            await createUserWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            console.error(error);
            handleAuthError(error);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };
    
    window.fazerLoginAnonimo = async () => {
        const btn = document.getElementById('btn-guest');
        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;

        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error(error);
            handleAuthError(error);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    };

    window.fazerLogout = async () => {
        try {
            await signOut(auth);
        } catch (error) {
            console.error(error);
        }
    };

    function handleAuthError(error) {
        if (error.code === 'auth/operation-not-allowed') {
            document.getElementById('firebase-help').classList.remove('hidden');
            showError("Erro de Configura칞칚o: Ative o login no Firebase Console.");
        } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
            showError("E-mail ou senha incorretos.");
        } else if (error.code === 'auth/email-already-in-use') {
            showError("Este e-mail j치 est치 cadastrado.");
        } else {
            showError("Erro: " + error.message);
        }
    }

    function showError(msg) {
        const errDiv = document.getElementById('login-error');
        errDiv.innerText = msg;
        errDiv.classList.remove('hidden');
        errDiv.classList.add('shake');
        setTimeout(() => errDiv.classList.remove('shake'), 500);
        
        document.getElementById('btn-login').disabled = false;
        document.getElementById('btn-login').innerText = "Entrar";
    }

    // 3. FIRESTORE LISTENER
    function initFirestoreListener() {
        if (!currentUser) return;
        
        const productsRef = collection(db, 'users', currentUser.uid, 'products');
        
        onSnapshot(productsRef, (snapshot) => {
            const select = document.getElementById('saved-products');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            productsCache = {};

            snapshot.forEach((doc) => {
                const data = doc.data();
                productsCache[doc.id] = data;
                
                const option = document.createElement('option');
                option.value = doc.id;
                option.innerText = data.name;
                select.appendChild(option);
            });
            if(productsCache[currentVal]) select.value = currentVal;
            
            // Se estiver na aba Dashboard, atualiza a tabela em tempo real
            if(document.getElementById('view-dash').classList.contains('block')) {
                updateDashboardTable();
            }
        }, (error) => {
            console.error("Firestore Error:", error);
            if(error.code === 'permission-denied') {
                console.warn("Aviso: Permiss칚o negada. Verifique as regras no Firestore Database.");
            }
        });
    }

    // 4. NAME FORMATTING & SAVING
    const nameInput = document.getElementById('prod-name');
    nameInput.addEventListener('input', (e) => {
        let val = e.target.value;
        if(val.length > 0) {
            const firstLetter = val.charAt(0).toUpperCase();
            const rest = val.slice(1);
            const formatted = (firstLetter + rest).replace(/\s+/g, '_');
            e.target.value = formatted;
        }
    });

    window.novoProduto = () => {
        document.getElementById('prod-id').value = "";
        document.getElementById('prod-name').value = "";
        document.getElementById('saved-products').value = "";
        document.getElementById('badge-mode').innerText = "NOVO";
        document.getElementById('badge-mode').className = "bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
        document.getElementById('btn-save-text').innerText = "Salvar";
        document.getElementById('btn-delete').classList.add('hidden');
        
        // Reset defaults
        document.getElementById('custo').value = "";
        document.getElementById('preco-venda').value = "";
        document.getElementById('extra').value = "0.00";
        document.getElementById('devolucao').value = "0";
        window.atualizarPrecificacao('slider');
    };

    window.excluirProduto = async () => {
        const docId = document.getElementById('prod-id').value;
        if (!currentUser || !docId) return alert("Selecione um produto para excluir.");
        
        if(confirm("Tem certeza que deseja excluir este produto?")) {
            const btn = document.getElementById('btn-delete');
            btn.innerHTML = '<div class="loader w-3 h-3"></div>';
            btn.disabled = true;
            
            try {
                const collectionRef = collection(db, 'users', currentUser.uid, 'products');
                await deleteDoc(doc(collectionRef, docId));
                alert("Produto exclu칤do!");
                window.novoProduto();
            } catch(e) {
                console.error(e);
                alert("Erro ao excluir: " + e.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                btn.disabled = false;
            }
        }
    };

    window.salvarProduto = async () => {
        if (!currentUser) return alert("Fa칞a login novamente.");
        const name = document.getElementById('prod-name').value;
        if (!name) return alert("Digite um nome para o produto.");

        const productData = {
            name: name,
            custo: document.getElementById('custo').value,
            extra: document.getElementById('extra').value,
            taxaFixa: document.getElementById('taxa-fixa').value,
            comissao: document.getElementById('comissao').value,
            imposto: document.getElementById('imposto').value,
            devolucao: document.getElementById('devolucao').value,
            descCupom: document.getElementById('desc-cupom').value,
            descRelampago: document.getElementById('desc-relampago').value,
            margem: document.getElementById('margem-slider').value,
            precoVenda: document.getElementById('preco-venda').value,
            // Salva ambos, mas um ser치 usado dependendo do modo
            adsMode: document.getElementById('ads-mode').value,
            adsInput: document.getElementById('ads-input').value,
            perfilAds: document.getElementById('perfil-ads').value,
            updatedAt: new Date().toISOString()
        };

        const btn = document.getElementById('btn-save');
        const originalText = document.getElementById('btn-save-text').innerText;
        document.getElementById('btn-save-text').innerText = "Salvando...";
        btn.disabled = true;

        try {
            let docId = document.getElementById('prod-id').value;
            const collectionRef = collection(db, 'users', currentUser.uid, 'products');

            if (docId && productsCache[docId]) {
                await updateDoc(doc(collectionRef, docId), productData);
            } else {
                const newRef = doc(collectionRef);
                docId = newRef.id;
                await setDoc(newRef, productData);
                document.getElementById('prod-id').value = docId;
                
                // Update UI to edit mode
                document.getElementById('badge-mode').innerText = `ID: ${docId.slice(0,4)}...`;
                document.getElementById('badge-mode').className = "bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
                document.getElementById('btn-delete').classList.remove('hidden');
            }

            document.getElementById('btn-save-text').innerText = "Salvo!";
            setTimeout(() => { 
                document.getElementById('btn-save-text').innerText = "Salvar"; 
                btn.disabled = false; 
            }, 2000);

        } catch (e) {
            console.error(e);
            alert("Erro ao salvar: " + e.message);
            document.getElementById('btn-save-text').innerText = originalText;
            btn.disabled = false;
        }
    };

    window.carregarProduto = (id) => {
        if (!id || !productsCache[id]) return;
        
        window.switchTab('calc');

        const data = productsCache[id];
        document.getElementById('prod-id').value = id;
        document.getElementById('prod-name').value = data.name;
        
        // UI Updates
        document.getElementById('badge-mode').innerText = `ID: ${id.slice(0,4)}...`;
        document.getElementById('badge-mode').className = "bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
        document.getElementById('btn-delete').classList.remove('hidden');
        document.getElementById('btn-save-text').innerText = "Atualizar";
        
        // Retrocompatibilidade para campos antigos (cpcEst)
        let loadedAdsInput = data.adsInput;
        if(loadedAdsInput === undefined || loadedAdsInput === null) {
             loadedAdsInput = data.cpcEst || 0.11;
        }

        const fields = {
            'custo': data.custo, 
            'extra': data.extra,
            'taxa-fixa': data.taxaFixa, 
            'comissao': data.comissao,
            'imposto': data.imposto, 
            'devolucao': data.devolucao,
            'desc-cupom': data.descCupom, 
            'desc-relampago': data.descRelampago,
            'margem-slider': data.margem, 
            'preco-venda': data.precoVenda, 
            'ads-mode': data.adsMode || 'cpc',
            'ads-input': loadedAdsInput,
            'perfil-ads': data.perfilAds
        };

        for (const [key, val] of Object.entries(fields)) {
            const el = document.getElementById(key);
            if(el) el.value = val !== undefined ? val : (key === 'extra' || key === 'devolucao' ? 0 : el.value);
        }
        
        window.toggleAdsMode();
        
        // CORRE칂츾O CR칈TICA: Use 'manual' para preservar o pre칞o carregado
        window.atualizarPrecificacao('manual'); 
        window.calcularGeral(false);
    };

    window.exportarBackup = () => {
        if (Object.keys(productsCache).length === 0) return alert("Nenhum produto para exportar.");
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(productsCache));
        const link = document.createElement('a');
        link.setAttribute("href", dataStr);
        link.setAttribute("download", "backup_shopee_ads.json");
        document.body.appendChild(link);
        link.click();
        link.remove();
    };

    window.importarBackup = async (input) => {
        if (!currentUser) return;
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                const batch = writeBatch(db);
                let count = 0;
                const collectionRef = collection(db, 'users', currentUser.uid, 'products');
                for (const [id, data] of Object.entries(json)) {
                    batch.set(doc(collectionRef, id), data);
                    count++;
                }
                await batch.commit();
                alert(`${count} produtos importados!`);
            } catch (err) {
                alert("Erro ao importar: " + err.message);
            }
        };
        reader.readAsText(file);
    };

    // --- DASHBOARD LOGIC ---
    window.switchTab = (tab) => {
        const calcBtn = document.getElementById('tab-calc');
        const dashBtn = document.getElementById('tab-dash');
        const viewCalc = document.getElementById('view-calc');
        const viewDash = document.getElementById('view-dash');

        if(tab === 'calc') {
            calcBtn.className = "flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 uppercase tracking-wide transition-colors";
            dashBtn.className = "flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors";
            viewCalc.classList.remove('hidden');
            viewDash.classList.add('hidden');
        } else {
            dashBtn.className = "flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 uppercase tracking-wide transition-colors";
            calcBtn.className = "flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors";
            viewDash.classList.remove('hidden');
            viewCalc.classList.add('hidden');
            updateDashboardTable();
        }
    }

    window.updateDashboardTable = () => {
        const tbody = document.getElementById('dash-tbody');
        const ids = Object.keys(productsCache);
        document.getElementById('dash-count').innerText = `${ids.length} produtos`;

        if(ids.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">Nenhum produto cadastrado.</td></tr>';
            return;
        }

        let html = '';
        ids.forEach(id => {
            const p = productsCache[id];
            
            // Recalcula lucros para exibir na tabela
            const pBase = parseFloat(p.precoVenda) || 0;
            const custo = parseFloat(p.custo) || 0;
            const extra = parseFloat(p.extra) || 0;
            const fixo = parseFloat(p.taxaFixa) || 0;
            
            const descC = (parseFloat(p.descCupom) || 0) / 100;
            const descR = (parseFloat(p.descRelampago) || 0) / 100;
            
            // Replicar a ordem l칩gica do c치lculo principal: 1췈 Rel칙mpago, 2췈 Cupom
            const pAposRelampago = pBase * (1 - descR);
            const pFinal = pAposRelampago * (1 - descC);
            
            const comissao = (parseFloat(p.comissao)||0)/100;
            const imposto = (parseFloat(p.imposto)||0)/100;
            const devolucao = (parseFloat(p.devolucao)||0)/100;
            
            const taxasTotal = pFinal * (comissao + imposto + devolucao);
            const lucro = pFinal - custo - extra - fixo - taxasTotal;
            const margem = pFinal > 0 ? (lucro / pFinal) * 100 : 0;

            const lucroClass = lucro >= 0 ? "text-green-600" : "text-red-600";
            const margemClass = margem >= 15 ? "bg-green-100 text-green-800" : (margem > 0 ? "bg-yellow-100 text-yellow-800" : "bg-red-100 text-red-800");

            html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                <td class="py-3 pl-2 font-bold text-gray-700">${p.name}</td>
                <td class="py-3 text-gray-600">R$ ${pFinal.toFixed(2)}</td>
                <td class="py-3 text-gray-400 text-xs">R$ ${custo.toFixed(2)}</td>
                <td class="py-3 font-bold ${lucroClass}">R$ ${lucro.toFixed(2)}</td>
                <td class="py-3 text-center">
                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${margemClass}">${margem.toFixed(1)}%</span>
                </td>
                <td class="py-3 pr-2 text-right">
                    <button onclick="carregarProduto('${id}')" class="text-blue-500 hover:text-blue-700 text-xs font-bold uppercase hover:underline">
                        Editar
                    </button>
                </td>
            </tr>
            `;
        });
        tbody.innerHTML = html;
    }
</script>

<script>
    // L칩gica de Neg칩cio (Global)
    const ids = ['custo', 'extra', 'taxa-fixa', 'comissao', 'imposto', 'devolucao', 'desc-cupom', 'desc-relampago', 'preco-venda', 'ads-input', 'perfil-ads'];
    const els = {};
    ids.forEach(id => els[id] = document.getElementById(id));
    const margemSlider = document.getElementById('margem-slider');
    const labelMargem = document.getElementById('label-margem');
    const lucroRealDisplay = document.getElementById('lucro-real');
    const precoFinalDisplay = document.getElementById('preco-final-display');

    const getVal = (id) => parseFloat(els[id].value) || 0;

    function calcularPrecoFinal(precoBase) {
        const descCupom = getVal('desc-cupom') / 100;
        const descRelampago = getVal('desc-relampago') / 100;
        // Ordem: Oferta Rel칙mpago -> Cupom Loja
        const aposRelampago = precoBase * (1 - descRelampago);
        return aposRelampago * (1 - descCupom);
    }

    window.toggleAdsMode = function() {
        const mode = document.getElementById('ads-mode').value;
        const label = document.getElementById('lbl-ads-input');
        const input = document.getElementById('ads-input');
        const container = document.getElementById('ads-input-container');
        
        if(mode === 'none') {
            container.classList.add('hidden');
        } else {
            container.classList.remove('hidden');
            if(mode === 'cpc') {
                label.innerText = "CPC Estimado (R$)";
                if(input.value > 10) input.value = 0.11; // Reset se parece porcentagem
            } else {
                label.innerText = "Convers칚o Estimada (%)";
                if(input.value < 1) input.value = 1.5; // Sugest칚o se for muito baixo
            }
        }
    }

    // Trigger de Atualiza칞칚o Autom치tica
    const triggerUpdate = (source) => {
        window.atualizarPrecificacao(source);
        window.calcularGeral(false); // False = No Scroll
    };

    ['custo', 'extra', 'taxa-fixa', 'comissao', 'imposto', 'devolucao', 'desc-cupom', 'desc-relampago'].forEach(id => {
        els[id].addEventListener('input', () => triggerUpdate('slider'));
    });
    margemSlider.addEventListener('input', () => triggerUpdate('slider'));
    // Ads inputs only trigger general calc, not price
    ['ads-input'].forEach(id => {
         document.getElementById(id).addEventListener('input', () => window.calcularGeral(false));
    });
    // Price input manual trigger
    els['preco-venda'].addEventListener('input', () => triggerUpdate('manual'));


    window.atualizarPrecificacao = function(origem) {
        const custo = getVal('custo');
        const extra = getVal('extra');
        const fixo = getVal('taxa-fixa');
        
        // Taxas Variaveis = Comissao + Imposto + Devolucao
        const taxasVariaveis = (getVal('comissao') + getVal('imposto') + getVal('devolucao')) / 100;
        
        const custosFixosReais = custo + extra + fixo;

        if (custo === 0) return;

        if (origem === 'slider') {
            const margemDesejada = parseFloat(margemSlider.value) / 100;
            labelMargem.innerText = (margemDesejada * 100).toFixed(0) + "%";
            
            // Formula Reversa: Pre칞o = (CustosFixos) / (1 - TaxasVariaveis - Margem)
            const divisor = 1 - taxasVariaveis - margemDesejada;
            
            if (divisor <= 0.05) { els['preco-venda'].value = 0; return; }
            
            const precoFinalAlvo = custosFixosReais / divisor;
            
            const descCupom = getVal('desc-cupom') / 100;
            const descRelampago = getVal('desc-relampago') / 100;
            const fatorDescontos = (1 - descCupom) * (1 - descRelampago);
            let precoBaseSugerido = precoFinalAlvo / fatorDescontos;
            
            // Arredondamento para .90
            // Ex: 65.38 -> 65.90 | 65.92 -> 66.90
            precoBaseSugerido = Math.ceil(precoBaseSugerido - 0.90) + 0.90;
            
            els['preco-venda'].value = precoBaseSugerido.toFixed(2);
        }

        const precoBase = getVal('preco-venda');
        const precoFinal = calcularPrecoFinal(precoBase);
        precoFinalDisplay.innerText = "R$ " + precoFinal.toFixed(2);
        
        const custoTotalTaxas = precoFinal * taxasVariaveis;
        const lucroLiquido = precoFinal - custosFixosReais - custoTotalTaxas;
        
        lucroRealDisplay.innerText = "R$ " + lucroLiquido.toFixed(2);
        lucroRealDisplay.className = lucroLiquido < 0 ? "text-xl font-black text-red-600" : "text-xl font-black text-green-600";

        if (origem === 'manual' && precoFinal > 0) {
            const margemReal = (lucroLiquido / precoFinal) * 100;
            labelMargem.innerText = margemReal.toFixed(1) + "%";
        }
    };

    window.calcularGeral = function(scroll = true) {
        const custo = getVal('custo');
        const extra = getVal('extra');
        const fixo = getVal('taxa-fixa');
        const precoBase = getVal('preco-venda');
        
        const taxasVariaveis = (getVal('comissao') + getVal('imposto') + getVal('devolucao')) / 100;
        
        const adsMode = document.getElementById('ads-mode').value;
        const adsInput = getVal('ads-input');
        const perfilAds = getVal('perfil-ads');

        const precoFinal = calcularPrecoFinal(precoBase);
        const custoTotalTaxas = precoFinal * taxasVariaveis;
        const lucroUnit = precoFinal - (custo + extra + fixo) - custoTotalTaxas;
        
        // --- 1. L칍GICA DE ADS (INVESTIMENTO) ---
        let cpaAlvo = 0;
        if(perfilAds == 0) {
            // Perfil: Sem Ads (Org칙nico)
            cpaAlvo = 0;
        } else {
            // Perfil com Ads: Investe X% do Lucro
            cpaAlvo = Math.max(lucroUnit * 0.5, lucroUnit * perfilAds);
        }
        
        // --- 2. L칍GICA DE MODO (CPC vs CONVERS츾O vs NENHUM) ---
        let displayMainVal = "";
        let displayMainLabel = "";
        let displayMainSub = "";
        
        if (perfilAds == 0) {
            // Se est치 sem Ads, n칚o faz sentido calcular CPC
            displayMainLabel = "Estrat칠gia Org칙nica";
            displayMainVal = "Sem Ads";
            displayMainSub = "Foco em SEO e Conte칰do";
            checkVereditoOrganic(lucroUnit);
        }
        else if (adsMode === 'cpc' || adsMode === 'none') {
            // Modo CPC ou Modo M칤nimo (Assume CPC 0.11)
            const cpc = adsMode === 'none' ? 0.11 : adsInput;
            
            // Engenharia Reversa: Qual convers칚o paga esse CPC?
            // CPA = CPC / Conv -> Conv = CPC / CPA
            const convMin = cpaAlvo > 0 ? (cpc / cpaAlvo) * 100 : 0;
            
            displayMainLabel = "Taxa de Convers칚o M칤nima";
            displayMainVal = convMin.toFixed(2) + "%";
            displayMainSub = "Para manter CPC R$ " + cpc.toFixed(2);
            
            checkVereditoConv(lucroUnit, convMin);
            
        } else {
            // Modo Convers칚o (Tenho taxa, quero saber CPC Teto)
            const conv = adsInput;
            const cpcMax = cpaAlvo * (conv / 100);
            
            displayMainLabel = "CPC M치ximo Permitido";
            displayMainVal = "R$ " + cpcMax.toFixed(2);
            displayMainSub = `Com convers칚o de ${conv}%`;
            
            checkVereditoCPC(lucroUnit, cpcMax);
        }

        // --- 3. C츼LCULO DE M칄TRICAS (ROAS, ACOS, CPA) ---
        // Se sem ads, ROAS/ACOS s칚o infinitos ou N/A
        const roasBreakeven = (lucroUnit > 0) ? (precoFinal / lucroUnit) : 0;
        const roasIdeal = (cpaAlvo > 0) ? (precoFinal / cpaAlvo) : 0;
        
        const acosBreakeven = roasBreakeven > 0 ? (100 / roasBreakeven) : 0;
        const acosIdeal = roasIdeal > 0 ? (100 / roasIdeal) : 0;
        
        const lucroPosAds = lucroUnit - cpaAlvo;

        // Atualiza Cards
        document.getElementById('res-cpa').innerText = "R$ " + cpaAlvo.toFixed(2);
        
        const elSobra = document.getElementById('res-cpa-restante');
        elSobra.innerText = "Sobra: R$ " + lucroPosAds.toFixed(2);
        elSobra.className = lucroPosAds >= 0 ? "block text-[10px] font-bold text-green-600 mt-1" : "block text-[10px] font-bold text-red-500 mt-1";

        document.getElementById('lbl-res-secondary').innerText = displayMainLabel;
        document.getElementById('res-secondary-val').innerText = displayMainVal;
        document.getElementById('res-secondary-sub').innerText = displayMainSub;

        // Formata칞칚o Condicional se "Sem Ads"
        if(perfilAds == 0) {
            document.getElementById('res-roas-ideal').innerText = "ROAS: -";
            document.getElementById('res-acos-ideal').innerText = "ACOS: 0%";
        } else {
            document.getElementById('res-roas-ideal').innerText = "ROAS: " + roasIdeal.toFixed(2);
            document.getElementById('res-acos-ideal').innerText = "ACOS: " + acosIdeal.toFixed(1) + "%";
        }
        
        document.getElementById('res-roas-breakeven').innerText = "ROAS: " + roasBreakeven.toFixed(2);
        document.getElementById('res-acos-breakeven').innerText = "ACOS: " + acosBreakeven.toFixed(1) + "%";

        renderizarProvaReal(precoBase, custo, extra, fixo);
        document.getElementById('results-area').classList.remove('hidden');
        if(scroll) {
            document.getElementById('results-area').scrollIntoView({ behavior: 'smooth' });
        }
    };
    
    function checkVereditoOrganic(lucroUnit) {
        const vContainer = document.getElementById('veredito-container');
        const vIcon = document.getElementById('veredito-icon');
        const vTitulo = document.getElementById('veredito-titulo');
        const vTexto = document.getElementById('veredito-texto');
        
        if (lucroUnit <= 0) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'red', 'PREJU칈ZO', 'Margem negativa mesmo sem an칰ncios.');
        } else {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'green', 'LUCRO ORG츽NICO', 'Sem custos de publicidade descontados.');
        }
    }
    
    function checkVereditoConv(lucroUnit, convMin) {
        const vContainer = document.getElementById('veredito-container');
        const vIcon = document.getElementById('veredito-icon');
        const vTitulo = document.getElementById('veredito-titulo');
        const vTexto = document.getElementById('veredito-texto');
        
        if (lucroUnit <= 0) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'red', 'PREJU칈ZO', 'Margem negativa. Revise pre칞os ou custos.');
        } else if (convMin > 3.0) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'red', 'DIF칈CIL', `Precisa converter ${convMin.toFixed(1)}%. Acima da m칠dia.`);
        } else if (convMin < 1.0) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'green', 'MUITO VI츼VEL', `Meta f치cil de ${convMin.toFixed(1)}% convers칚o.`);
        } else {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'blue', 'VI츼VEL (PADR츾O)', `Meta de ${convMin.toFixed(1)}% 칠 ating칤vel.`);
        }
    }
    
    function checkVereditoCPC(lucroUnit, cpcMax) {
        const vContainer = document.getElementById('veredito-container');
        const vIcon = document.getElementById('veredito-icon');
        const vTitulo = document.getElementById('veredito-titulo');
        const vTexto = document.getElementById('veredito-texto');
        
        if (lucroUnit <= 0) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'red', 'PREJU칈ZO', 'Margem negativa.');
        } else if (cpcMax < 0.11) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'red', 'INVI츼VEL', `CPC Teto R$ ${cpcMax.toFixed(2)} 칠 menor que o m칤nimo.`);
        } else if (cpcMax > 0.50) {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'green', 'EXCELENTE', `Voc칡 pode pagar at칠 R$ ${cpcMax.toFixed(2)} por clique.`);
        } else {
             setVeredito(vContainer, vIcon, vTitulo, vTexto, 'blue', 'VI츼VEL', `Lance teto de R$ ${cpcMax.toFixed(2)} est치 na m칠dia.`);
        }
    }
    
    function setVeredito(cont, icon, tit, txt, color, title, desc) {
        const colors = {
            red: ['border-red-500', 'bg-red-50', 'text-red-500'],
            green: ['border-green-500', 'bg-green-50', 'text-green-500'],
            blue: ['border-blue-500', 'bg-blue-50', 'text-blue-500']
        };
        const c = colors[color];
        cont.className = `p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 ${c[1]} ${c[0]}`;
        icon.className = `text-2xl mt-1 ${c[2]}`;
        icon.innerHTML = color === 'red' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-check-circle"></i>';
        tit.innerText = title;
        tit.className = `font-bold text-sm uppercase ${c[2]}`;
        txt.innerText = desc;
    }

    function renderizarProvaReal(precoBase, custo, extra, fixo) {
        const descCupom = getVal('desc-cupom');
        const descRelampago = getVal('desc-relampago');
        const comissao = getVal('comissao');
        const imposto = getVal('imposto');
        const devolucao = getVal('devolucao');

        // C치lculos detalhados: 1췈 Oferta Rel칙mpago -> 2췈 Cupom Loja
        const valDescRelampago = precoBase * (descRelampago / 100);
        const precoAposRelampago = precoBase - valDescRelampago;
        
        const valDescCupom = precoAposRelampago * (descCupom / 100);
        const precoFinal = precoAposRelampago - valDescCupom;

        const valComissao = precoFinal * (comissao / 100);
        const valImposto = precoFinal * (imposto / 100);
        
        // Devolu칞칚o calculada sobre o pre칞o final
        const valDevolucao = precoFinal * (devolucao / 100);

        const custoTotal = custo + extra + fixo + valComissao + valImposto + valDevolucao;
        const lucroFinal = precoFinal - custoTotal;

        const container = document.getElementById('breakdown-container');
        const row = (label, pct, val, colorClass='text-gray-600', isTotal=false) => `
            <div class="flex justify-between items-center ${isTotal ? 'font-bold border-t border-gray-300 pt-2 mt-2' : ''}">
                <span class="${colorClass}">${label} ${pct ? `(${pct}%)` : ''}</span>
                <span class="${colorClass}">${val < 0 ? '-' : ''} R$ ${Math.abs(val).toFixed(2)}</span>
            </div>
        `;

        container.innerHTML = `
            ${row('Pre칞o de Venda (Base)', null, precoBase, 'text-gray-800 font-bold')}
            ${descRelampago > 0 ? row('(-) Oferta Rel칙mpago', descRelampago, -valDescRelampago, 'text-red-500') : ''}
            ${descCupom > 0 ? row('(-) Cupom Loja', descCupom, -valDescCupom, 'text-red-500') : ''}
            
            <div class="border-t border-dashed border-gray-300 my-2"></div>
            
            ${row('(=) Pre칞o Venda (Nota Fiscal)', null, precoFinal, 'text-blue-800 font-bold')}
            ${devolucao > 0 ? row('(-) Devolu칞칚o Estimada', devolucao, -valDevolucao, 'text-red-500 font-bold') : ''}
            
            ${row('(-) Custo do Produto', null, -custo, 'text-red-400')}
            ${row('(-) Custos Extras', null, -extra, 'text-red-400')}
            ${row('(-) Taxa Fixa Shopee', null, -fixo, 'text-red-400')}
            ${row('(-) Comiss칚o Shopee', comissao, -valComissao, 'text-red-400')}
            ${row('(-) Impostos', imposto, -valImposto, 'text-red-400')}
            
            ${row('(=) LUCRO L칈QUIDO FINAL', null, lucroFinal, lucroFinal >= 0 ? 'text-green-600 text-base' : 'text-red-600 text-base', true)}
            
            <div class="mt-2 text-[10px] text-gray-400 text-right">
                Margem Real: ${((lucroFinal/precoFinal)*100).toFixed(2)}%
            </div>
        `;
    }
</script>

</body>
</html>
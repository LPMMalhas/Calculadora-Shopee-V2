<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velt.AI - Precifica√ß√£o Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .shopee-gradient { background: linear-gradient(135deg, #ee4d2d 0%, #ff7337 100%); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        input[type=range] { accent-color: #ee4d2d; }
        input:focus { ring: 2px; ring-color: #ee4d2d; border-color: #ee4d2d; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ee4d2d; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 10% { transform: translate(-1px, -2px); } 20% { transform: translate(-3px, 0px); } 30% { transform: translate(3px, 2px); } 40% { transform: translate(1px, -1px); } 50% { transform: translate(-1px, 2px); } 60% { transform: translate(-3px, 1px); } 70% { transform: translate(3px, 1px); } 80% { transform: translate(-1px, -1px); } 90% { transform: translate(1px, 2px); } 100% { transform: translate(1px, -2px); } }
    
        /* Custom Scrollbar for Table */
        .table-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
        .table-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .table-scroll::-webkit-scrollbar-track { background: #f1f5f9; }

        /* ESTILOS DE IMPRESS√ÉO (PDF - OTIMIZADO A4) */
        @media print {
            @page { margin: 0.5cm; size: A4; }
            
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
                font-size: 10px; 
            }

            /* Ocultar elementos de navega√ß√£o e intera√ß√£o */
            #login-screen, button, .no-print, #tab-calc, #tab-dash, #tab-ads,
            #auth-status-container, #firebase-help, .fa-print, .fa-sign-out-alt, 
            input[type=range], #btn-delete, #btn-save, .fa-plus, .fa-save, .fa-trash-alt, .fa-eraser,
            #ads-saved-products, .fa-chevron-down, .action-bar, #dash-search-container { 
                display: none !important; 
            }

            #app-content { 
                box-shadow: none; max-width: 100%; width: 100%; margin: 0; border-radius: 0;
                transform: scale(0.95); /* Aumentado para melhor legibilidade */
                transform-origin: top center;
                overflow: visible;
            }

            .shopee-gradient { 
                background: #ee4d2d !important; color: white !important; 
                -webkit-print-color-adjust: exact; padding: 10px !important;
                border-radius: 0 !important; margin-bottom: 5px !important;
            }
            .shopee-gradient h1 { font-size: 14px !important; }
            .shopee-gradient p { font-size: 8px !important; }

            .p-6, .p-8, .md\:p-8 { padding: 0 !important; }
            .p-5, .p-4 { padding: 5px !important; }
            
            .space-y-8 > :not([hidden]) ~ :not([hidden]) { margin-top: 10px !important; }
            .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 5px !important; }
            .mb-8, .mb-4, .mb-3, .mb-2 { margin-bottom: 3px !important; }
            .mt-6, .mt-5, .mt-4 { margin-top: 5px !important; }
            .gap-4 { gap: 5px !important; }
            .gap-3 { gap: 4px !important; }
            
            input, select { 
                border: none !important; background: transparent !important; 
                appearance: none; -webkit-appearance: none; padding: 0 !important; 
                font-weight: bold; color: #000; font-size: 11px !important;
                height: auto !important; width: auto !important; display: inline-block;
            }

            .bg-gray-50, .bg-blue-50, .bg-red-50, .bg-green-50, .bg-orange-50, .bg-purple-50, .bg-yellow-50 {
                background-color: transparent !important;
                border: 1px solid #e5e7eb !important; border-radius: 4px !important;
                padding: 5px !important;
            }
            
            /* QUEBRA DE P√ÅGINA: For√ßa Simula√ß√£o e Prova Real para a pr√≥xima p√°gina */
            #organic-simulation-wrapper {
                page-break-before: always;
                margin-top: 20px !important;
                display: block !important;
            }
            
            /* Garante que a Prova Real n√£o quebre no meio */
            #breakdown-container {
                page-break-inside: avoid;
            }
            
            /* Ocultar explicitamente abas n√£o ativas na impress√£o */
            .hidden { display: none !important; } 
            
            .fa-chevron-down, .absolute.left-3, .absolute.right-3 { display: none !important; }
            input[type=number] { padding-left: 0 !important; }
        }
    </style>
</head>
<body class="text-gray-800 antialiased min-h-screen flex flex-col items-center justify-center py-4 md:py-8 px-4">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="w-full max-w-sm bg-white rounded-3xl overflow-hidden card-shadow p-8 transition-all">
        <div class="text-center mb-8">
            <div class="inline-block p-4 rounded-full bg-orange-50 mb-4">
                <i class="fas fa-rocket text-4xl text-[#ee4d2d]"></i>
            </div>
            <h1 class="text-2xl font-extrabold text-gray-800">Velt.AI Cloud</h1>
            <p class="text-sm text-gray-400 mt-1">Precifica√ß√£o Inteligente & Ads</p>
        </div>

        <div class="space-y-4">
            <div id="firebase-help" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 text-left mb-4">
                <div class="flex items-start gap-2">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                    <div>
                        <h4 class="text-xs font-bold text-yellow-800 uppercase">Configura√ß√£o Necess√°ria</h4>
                        <p class="text-[10px] text-yellow-700 mt-1 leading-relaxed">
                            Ative <b>Email/Password</b> e <b>Anonymous</b> no Firebase Console.
                        </p>
                    </div>
                </div>
            </div>

            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">E-mail</label>
                <input type="email" id="login-email" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="seu@email.com">
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Senha</label>
                <input type="password" id="login-password" class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl text-sm font-bold outline-none focus:border-[#ee4d2d] transition-all" placeholder="********">
            </div>
            
            <div id="login-error" class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-600 text-xs text-center hidden"></div>

            <button onclick="fazerLogin()" id="btn-login" class="w-full py-3.5 shopee-gradient text-white font-bold rounded-xl shadow-lg hover:opacity-90 transition-all">
                Entrar
            </button>
            
            <button onclick="fazerLoginAnonimo()" id="btn-guest" class="w-full py-2 bg-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-200 transition-all text-xs uppercase">
                Entrar como Convidado
            </button>
            
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-xs">ou</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <button onclick="fazerCadastro()" id="btn-register" class="w-full py-3.5 bg-white border-2 border-gray-100 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition-all">
                Criar Conta Gr√°tis
            </button>
        </div>
    </div>

    <!-- APP PRINCIPAL -->
    <div id="app-content" class="hidden w-full max-w-4xl bg-white rounded-3xl overflow-hidden card-shadow transition-all duration-300">
        
        <!-- Header -->
        <div class="shopee-gradient p-6 text-white text-center relative flex justify-between items-center">
            <div class="w-8"></div>
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight">Velt.AI <span class="font-light opacity-90">| Cloud</span></h1>
                <p class="text-xs font-medium uppercase tracking-widest mt-1 opacity-90">Precifica√ß√£o, Ads & Firebase</p>
            </div>
            <div class="flex gap-4">
                <i class="fas fa-print cursor-pointer text-white text-xl opacity-80 hover:opacity-100 transition-opacity" onclick="imprimirRelatorio()" title="Imprimir / Salvar PDF"></i>
                <i class="fas fa-sign-out-alt cursor-pointer text-white text-xl opacity-60 hover:opacity-100 transition-opacity no-print" onclick="fazerLogout()" title="Sair da Conta"></i>
            </div>
        </div>

        <!-- Navega√ß√£o Tabs -->
        <div class="flex border-b border-gray-200 bg-white sticky top-0 z-10 no-print">
            <button id="tab-calc" onclick="switchTab('calc')" class="flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-calculator mr-1"></i> Calculadora
            </button>
            <button id="tab-ads" onclick="switchTab('ads')" class="flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-search-dollar mr-1"></i> An√°lise Ads
            </button>
            <button id="tab-dash" onclick="switchTab('dash')" class="flex-1 py-4 text-xs font-bold text-gray-400 hover:text-gray-600 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors">
                <i class="fas fa-chart-line mr-1"></i> Dashboard
            </button>
        </div>

        <!-- ABA CALCULADORA -->
        <div id="view-calc" class="p-6 md:p-8 space-y-8 animate-fade-in">

            <!-- GEST√ÉO DE PRODUTOS -->
            <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 md:p-5 relative">
                <div class="absolute -top-3 left-4 bg-gray-800 text-white text-[10px] font-bold px-2 py-0.5 rounded no-print">GEST√ÉO DE PRODUTOS</div>
                
                <div class="flex justify-between items-center mb-3" id="auth-status-container">
                    <div id="db-mode" class="text-[9px] font-bold uppercase text-gray-400">Projeto Pessoal</div>
                    <div class="text-[10px] text-right text-gray-400 flex items-center gap-2">
                        <span id="auth-status">Conectado</span>
                        <span id="badge-mode" class="bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]">NOVO</span>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-3 mb-4">
                    <div class="flex-grow">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Nome do Produto</label>
                        <input type="text" id="prod-name" placeholder="Ex: Tenis_Corrida" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold outline-none focus:border-orange-500 uppercase transition-all">
                        <input type="hidden" id="prod-id">
                    </div>
                    <div class="flex items-end gap-2 no-print">
                        <button onclick="novoProduto()" class="py-2 px-4 bg-white border border-gray-300 text-gray-600 rounded-lg text-sm font-bold shadow-sm hover:bg-gray-50 transition-all h-[42px]" title="Limpar Campos / Novo Produto">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button onclick="salvarProduto()" id="btn-save" class="py-2 px-6 bg-gray-800 hover:bg-gray-700 text-white rounded-lg text-sm font-bold shadow-sm transition-all flex items-center justify-center gap-2 h-[42px] min-w-[120px]">
                            <i class="fas fa-save"></i> <span id="btn-save-text">Salvar</span>
                        </button>
                    </div>
                </div>

                <div class="flex items-end gap-2 no-print">
                    <div class="flex-grow relative">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Carregar Produto Salvo</label>
                        <select id="saved-products" onchange="carregarProduto(this.value)" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm outline-none cursor-pointer appearance-none">
                            <option value="">Selecione um produto...</option>
                        </select>
                        <div class="absolute right-3 bottom-2.5 pointer-events-none text-gray-400"><i class="fas fa-chevron-down text-xs"></i></div>
                    </div>
                    <button onclick="excluirProduto()" id="btn-delete" class="py-2 px-4 bg-red-50 border border-red-200 text-red-600 rounded-lg text-sm font-bold shadow-sm hover:bg-red-100 hover:border-red-300 transition-all h-[42px] hidden" title="Excluir Este Produto">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>

                <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-200 no-print action-bar">
                    <button onclick="limparCalculadora()" class="text-[10px] font-bold text-red-500 hover:text-red-700 flex items-center gap-1 uppercase transition-all">
                        <i class="fas fa-eraser mr-1"></i> Limpar Tudo
                    </button>
                    <div class="flex gap-3">
                        <button onclick="exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                            <i class="fas fa-upload"></i> Importar
                            <input type="file" id="import-file-calc" class="hidden" onchange="importarBackup(this)">
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 1. CUSTOS E TAXAS -->
            <div class="space-y-4">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600 no-print"><i class="fas fa-file-invoice-dollar text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">1. Custos e Comiss√µes</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Custo Produto (R$)</label>
                        <input type="number" id="custo" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Extras (Embalagem) (R$)</label>
                        <input type="number" id="extra" value="0.00" step="0.01" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold outline-none transition-all" placeholder="0.00">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Fixa Shopee (R$)</label>
                        <input type="number" id="taxa-fixa" value="4.00" step="0.50" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Comiss√£o (%)</label>
                        <input type="number" id="comissao" value="20" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Imposto (%)</label>
                        <input type="number" id="imposto" value="4" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-center outline-none">
                    </div>
                </div>

                <div class="bg-red-50 p-4 rounded-xl border border-red-100">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-level-down-alt text-red-500 no-print"></i>
                        <span class="text-xs font-bold text-red-700 uppercase">Descontos & Perdas</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">1¬∫ Oferta Rel√¢mpago (%)</label>
                            <input type="number" id="desc-relampago" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-red-400 uppercase">2¬∫ Cupom Loja (%)</label>
                            <input type="number" id="desc-cupom" value="0" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none">
                        </div>
                        <div class="space-y-1 col-span-2">
                            <label class="text-[9px] font-bold text-red-400 uppercase">3¬∫ Est. Devolu√ß√£o (%)</label>
                            <input type="number" id="devolucao" value="0" step="0.1" class="w-full px-3 py-2 bg-white border border-red-200 rounded-lg text-sm font-bold text-center text-red-600 outline-none" placeholder="Ex: 3%">
                        </div>
                    </div>
                </div>

                <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 relative mt-6 no-print">
                    <div class="absolute -top-3 left-4 bg-blue-600 text-white text-[10px] font-bold px-2 py-0.5 rounded no-print">Definir Margem no Pre√ßo Final</div>
                    <div class="flex justify-between items-center mb-4 mt-2">
                        <span class="text-xs font-bold text-blue-800">Margem L√≠quida Alvo</span>
                        <span id="label-margem" class="text-lg font-black text-blue-600">15%</span>
                    </div>
                    <input type="range" id="margem-slider" min="5" max="50" value="15" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <div class="grid grid-cols-2 gap-4 mt-5 pt-4 border-t border-blue-200">
                        <div>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mb-1">Pre√ßo Base (Sem Descontos)</span>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-blue-500 text-xs font-bold">R$</span>
                                <input type="number" id="preco-venda" step="0.01" class="w-full pl-8 pr-2 py-2 bg-white border border-blue-200 rounded-lg text-xl font-black text-blue-900 focus:outline-none focus:border-blue-500 shadow-sm">
                            </div>
                        </div>
                        <div class="text-right flex flex-col justify-center">
                            <span class="block text-[9px] font-bold text-gray-500 uppercase">Pre√ßo Final (Calculado)</span>
                            <span id="preco-final-display" class="text-sm font-bold text-gray-700">R$ 0,00</span>
                            <span class="block text-[9px] font-bold text-blue-400 uppercase mt-1">Lucro L√≠quido Real</span>
                            <span id="lucro-real" class="text-xl font-black text-green-600">R$ 0,00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ADS ESTRAT√âGIA -->
            <div class="space-y-4 no-print">
                <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                    <div class="bg-orange-100 p-1.5 rounded-lg text-orange-600 no-print"><i class="fas fa-bullseye text-sm"></i></div>
                    <h2 class="text-sm font-bold text-gray-700 uppercase">2. Estrat√©gia de Ads</h2>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Seletor de Modo -->
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Base de C√°lculo</label>
                        <select id="ads-mode" onchange="toggleAdsMode(); calcularGeral(false);" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold text-gray-700 focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="cpc">Tenho o CPC (R$)</option>
                            <option value="conv">Tenho a Convers√£o (%)</option>
                            <option value="none">Sem dados (Simular M√≠nimos)</option>
                        </select>
                    </div>
                    
                    <!-- Campo Din√¢mico (CPC ou Convers√£o) -->
                    <div class="space-y-1" id="ads-input-container">
                        <label id="lbl-ads-input" class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">CPC Estimado (R$)</label>
                        <input type="number" id="ads-input" value="0.11" step="0.01" class="w-full px-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                    </div>
                    
                    <!-- Perfil -->
                    <div class="col-span-2 space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-wide">Perfil de Investimento</label>
                        <select id="perfil-ads" onchange="toggleAdsProfile(); calcularGeral(false)" class="w-full px-3 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm font-bold focus:ring-2 focus:ring-orange-500 outline-none">
                            <option value="0.5" selected>‚öñÔ∏è Equilibrado (Min 50% Lucro)</option>
                            <option value="0.75">üöÄ Agressivo (75% Lucro)</option>
                            <option value="0.95">üëë Domina√ß√£o (95% Lucro)</option>
                            <option value="0">üå± Sem Ads (100% Lucro)</option>
                            <option value="custom">üéØ Definir CPA M√°ximo (R$)</option>
                        </select>
                    </div>

                    <div id="custom-cpa-container" class="hidden col-span-2 space-y-1 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                        <label class="text-[10px] font-bold text-yellow-700 uppercase tracking-wide">Quanto quer gastar por venda? (R$)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2 text-yellow-600 text-xs font-bold">R$</span>
                            <input type="number" id="custom-cpa" value="10.00" step="0.50" class="w-full pl-8 pr-3 py-2 bg-white border border-yellow-300 rounded-lg text-sm font-bold text-yellow-900 focus:outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESULTADOS -->
            <div id="results-area" class="hidden space-y-6 animate-fade-in border-t-2 border-dashed border-gray-200 pt-6">
                
                <div id="ads-metrics-wrapper">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200 shadow-sm text-center flex flex-col justify-center">
                            <span class="block text-[9px] uppercase font-bold text-gray-400 mb-1">Breakeven (Zero a Zero)</span>
                            <span id="res-roas-breakeven" class="text-xl font-black text-gray-600">ROAS: 0.00</span>
                            <span id="res-acos-breakeven" class="block text-[10px] font-bold text-gray-400 mt-1">ACOS: 0%</span>
                        </div>
                        <div class="bg-green-50 p-3 rounded-xl border border-green-200 shadow-sm text-center relative flex flex-col justify-center">
                            <div class="absolute -top-2 -right-2 bg-green-500 text-white text-[8px] px-1.5 py-0.5 rounded-full font-bold no-print">META</div>
                            <span class="block text-[9px] uppercase font-bold text-green-600 mb-1">Ideal (Meta)</span>
                            <span id="res-roas-ideal" class="text-2xl font-black text-green-600">ROAS: 0.00</span>
                            <span id="res-acos-ideal" class="block text-[10px] font-bold text-green-600 mt-1">ACOS: 0%</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm text-center">
                            <span class="block text-[10px] uppercase font-bold text-purple-600 mb-1">Custo por Convers√£o (CPA)</span>
                            <span id="res-cpa" class="text-xl font-black text-purple-700">R$ 0,00</span>
                            <span id="res-cpa-restante" class="block text-[10px] font-bold text-gray-400 mt-1">Sobra: R$ 0,00</span>
                        </div>
                        <!-- CARD DIN√ÇMICO -->
                        <div class="bg-orange-50 p-3 rounded-xl border border-orange-200 shadow-sm text-center">
                            <span id="lbl-res-secondary" class="block text-[10px] uppercase font-bold text-orange-600 mb-1">Taxa de Convers√£o M√≠nima</span>
                            <span id="res-secondary-val" class="text-2xl font-black text-orange-600">0.00%</span>
                            <span id="res-secondary-sub" class="block text-[10px] font-bold text-orange-500 mt-1">Custo: R$ 0,00</span>
                        </div>
                    </div>

                    <div id="veredito-container" class="p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 bg-gray-50 border-gray-300 mt-4">
                        <div id="veredito-icon" class="text-2xl mt-1 text-gray-400"><i class="fas fa-info-circle"></i></div>
                        <div>
                            <h3 id="veredito-titulo" class="font-bold text-sm uppercase text-gray-700">Aguardando...</h3>
                            <p id="veredito-texto" class="text-xs text-gray-600 mt-1">Preencha os dados.</p>
                        </div>
                    </div>
                </div>

                <!-- CONTAINER DE SIMULA√á√ÉO DE OFERTA (CUSTOM + TABELA) -->
                <div id="organic-simulation-wrapper" class="hidden mt-6 bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                    <div class="flex items-center gap-2 mb-3 pb-2 border-b border-yellow-200">
                        <i class="fas fa-bolt text-yellow-600 text-sm"></i>
                        <h2 class="text-sm font-bold text-yellow-700 uppercase">Simula√ß√£o de Oferta Rel√¢mpago (+1% a +10%)</h2>
                    </div>
                    
                    <!-- INPUT DE SIMULA√á√ÉO PERSONALIZADA -->
                    <div class="mb-4 bg-white p-3 rounded-lg border border-yellow-100 flex items-center justify-between shadow-sm">
                        <div>
                             <label class="block text-[9px] font-bold text-gray-500 uppercase mb-1">Teste um Desconto (%)</label>
                             <input type="number" id="sim-custom-pct" placeholder="Ex: 50" class="w-24 px-3 py-1 bg-yellow-50 border border-yellow-300 rounded text-center font-black text-yellow-800 outline-none focus:ring-2 focus:ring-yellow-400" oninput="simularDescontoPersonalizado()">
                        </div>
                        <div class="text-right flex gap-4 text-xs">
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Novo Pre√ßo</span>
                                 <span id="sim-custom-price" class="font-bold text-gray-700">R$ 0,00</span>
                             </div>
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Lucro L√≠q.</span>
                                 <span id="sim-custom-profit" class="font-bold">R$ 0,00</span>
                             </div>
                             <div>
                                 <span class="block text-[8px] text-gray-400 uppercase">Margem</span>
                                 <span id="sim-custom-margin" class="font-bold">0%</span>
                             </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse bg-white rounded-lg overflow-hidden border border-gray-200">
                            <thead class="bg-gray-50 text-[10px] text-gray-500 uppercase">
                                <tr>
                                    <th class="px-3 py-2 text-center">Desc. Total</th>
                                    <th class="px-3 py-2 text-right">Novo Pre√ßo</th>
                                    <th class="px-3 py-2 text-right">Lucro L√≠q.</th>
                                    <th class="px-3 py-2 text-center">Margem</th>
                                </tr>
                            </thead>
                            <tbody id="organic-simulation-body" class="text-xs">
                                <!-- JS Populates -->
                            </tbody>
                        </table>
                    </div>
                    <p class="text-[8px] text-yellow-600 mt-2 text-center italic">*Esta simula√ß√£o n√£o altera os dados salvos do produto acima.</p>
                </div>

                <div class="space-y-3 mt-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="bg-blue-100 p-1 rounded text-blue-600 no-print"><i class="fas fa-list-ol text-xs"></i></div>
                        <h4 class="text-xs font-bold text-gray-700 uppercase">Prova Real (Detalhamento)</h4>
                    </div>
                    <div id="breakdown-container" class="bg-gray-50 p-5 rounded-xl border border-gray-200 text-sm space-y-3 font-mono">
                        <!-- JS preenche aqui -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ABA AN√ÅLISE ADS (NOVA) -->
        <div id="view-ads-analysis" class="hidden p-6 md:p-8 space-y-8 animate-fade-in">
             <div class="flex items-center gap-2 mb-2 border-b border-gray-100 pb-2">
                <div class="bg-purple-100 p-1.5 rounded-lg text-purple-600 no-print"><i class="fas fa-microscope text-sm"></i></div>
                <h2 class="text-sm font-bold text-gray-700 uppercase">Diagn√≥stico de Campanha Real</h2>
            </div>
            
            <!-- SELETOR DE PRODUTO -->
            <div class="bg-purple-50 border border-purple-200 p-3 rounded-xl mb-4 no-print">
                <label class="text-[10px] font-bold text-purple-700 uppercase tracking-wide block mb-1">Selecionar Produto Cadastrado</label>
                <div class="relative">
                    <select id="ads-saved-products" onchange="carregarProdutoAds(this.value)" class="w-full px-3 py-2 bg-white border border-purple-300 rounded-lg text-sm font-bold text-purple-900 outline-none cursor-pointer appearance-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- Selecione para comparar --</option>
                    </select>
                    <div class="absolute right-3 top-2.5 pointer-events-none text-purple-500"><i class="fas fa-chevron-down text-xs"></i></div>
                </div>
                <div id="ads-product-info" class="hidden mt-3 pt-3 border-t border-purple-200 grid grid-cols-3 gap-2 text-center">
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Margem Real</span>
                        <span id="ads-info-margin" class="text-xs font-black text-purple-900">0%</span>
                    </div>
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Lucro Unit.</span>
                        <span id="ads-info-profit" class="text-xs font-black text-purple-900">R$ 0,00</span>
                    </div>
                    <div>
                        <span class="block text-[8px] text-purple-500 uppercase font-bold">Breakeven ROAS</span>
                        <span id="ads-info-roas" class="text-xs font-black text-purple-900">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Inputs da Campanha -->
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Impress√µes</label>
                    <input type="number" id="camp-impressions" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Cliques</label>
                    <input type="number" id="camp-clicks" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="analisarCampanha()">
                </div>
                 <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Investimento (R$)</label>
                    <input type="number" id="camp-expense" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-red-500 focus:outline-none focus:border-red-500" oninput="analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">GMV (Receita R$)</label>
                    <input type="number" id="camp-gmv" placeholder="0.00" step="0.01" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-green-600 focus:outline-none focus:border-green-500" oninput="analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Convers√µes</label>
                    <input type="number" id="camp-conversions" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="analisarCampanha()">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-bold text-gray-500 uppercase">Itens Vendidos</label>
                    <input type="number" id="camp-items" placeholder="0" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-bold text-gray-700 focus:outline-none" oninput="analisarCampanha()">
                </div>
            </div>

            <!-- Resultados da An√°lise -->
            <div id="camp-results" class="hidden space-y-6">
                <!-- COMP TABLE (ADDED HERE) -->
                <div id="comp-analysis-container" class="hidden bg-white border border-gray-300 rounded-xl overflow-hidden">
                     <table class="w-full text-sm text-left">
                         <thead class="bg-gray-100 text-xs text-gray-600 uppercase"><tr><th class="px-4 py-2">M√©trica</th><th class="px-4 py-2">Meta</th><th class="px-4 py-2">Real</th><th class="px-4 py-2 text-center">A√ß√£o Recomendada</th></tr></thead>
                         <tbody id="comp-analysis-body" class="divide-y divide-gray-100"></tbody>
                     </table>
                     <div id="comp-diagnostic-text" class="p-4 bg-yellow-50 text-xs text-yellow-800 font-medium border-t border-gray-200"></div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 text-center flex flex-col justify-center">
                        <span class="block text-[10px] font-bold text-blue-800 uppercase mb-1">ROAS Obtido</span>
                        <span id="res-camp-roas" class="text-3xl font-black text-blue-900">0.00</span>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl border border-purple-200 text-center flex flex-col justify-center">
                        <span class="block text-[10px] font-bold text-purple-800 uppercase mb-1">ACOS (Custo/Venda %)</span>
                        <span id="res-camp-acos" class="text-3xl font-black text-purple-900">0.0%</span>
                    </div>
                </div>
                <div id="camp-profit-box" class="bg-gray-100 border border-gray-300 p-4 rounded-xl text-center hidden"><span class="block text-[10px] font-bold text-gray-500 uppercase">Lucro L√≠quido Campanha</span><span id="res-camp-profit" class="text-2xl font-black text-gray-800">R$ 0,00</span><p id="res-camp-profit-desc" class="text-[9px] text-gray-400 mt-1"></p></div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">CTR</span><span id="res-camp-ctr" class="text-lg font-bold">0%</span></div>
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Taxa Convers√£o</span><span id="res-camp-cr" class="text-lg font-bold">0%</span></div>
                     <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Custo p/ Convers√£o</span><span id="res-camp-cpa" class="text-lg font-bold">R$ 0</span></div>
                    <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Custo p/ Clique (CPC)</span><span id="res-camp-cpc" class="text-lg font-bold">R$ 0</span></div>
                </div>
                <div class="bg-white border p-3 rounded-lg text-center"><span class="block text-[8px] font-bold text-gray-400 uppercase">Itens Vendidos</span><span id="res-camp-items" class="text-lg font-bold text-gray-700">0</span></div>
                <div class="bg-gray-50 border-l-4 border-gray-400 p-4 rounded-r-xl"><h4 class="text-xs font-bold text-gray-700 uppercase mb-1">Diagn√≥stico R√°pido</h4><p id="camp-verdict" class="text-xs text-gray-600 leading-relaxed">-</p></div>
                
                <!-- BARRA DE A√á√ïES AN√ÅLISE ADS -->
                <div class="action-bar flex justify-end gap-3 mt-4 pt-3 border-t border-gray-200 no-print">
                    <button onclick="imprimirRelatorio('ads')" class="text-[10px] font-bold text-gray-600 hover:text-gray-800 flex items-center gap-1 uppercase">
                        <i class="fas fa-print"></i> Imprimir Diagn√≥stico
                    </button>
                    <button onclick="exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                        <i class="fas fa-download"></i> Exportar
                    </button>
                    <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                        <i class="fas fa-upload"></i> Importar
                        <input type="file" id="import-file-ads" class="hidden" onchange="importarBackup(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- ABA DASHBOARD -->
        <div id="view-dash" class="hidden p-6 md:p-8 animate-fade-in">
            <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg text-gray-700">Portf√≥lio de Produtos</h3><span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded-full font-mono" id="dash-count">0 produtos</span></div>
            
            <!-- Search Box -->
            <div class="mb-4 relative" id="dash-search-container">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="dash-search" placeholder="Buscar produto..." class="w-full py-2 pl-10 pr-4 bg-white border border-gray-200 rounded-xl text-sm font-bold text-gray-700 outline-none focus:border-orange-500 transition-all" oninput="updateDashboardTable()">
            </div>

            <div class="overflow-x-auto table-scroll">
                <table class="w-full text-left border-collapse">
                    <thead><tr class="text-[10px] uppercase text-gray-400 border-b border-gray-200"><th class="py-2 pl-2">Produto</th><th class="py-2">Pre√ßo</th><th class="py-2">Custo</th><th class="py-2">Lucro</th><th class="py-2 text-center">Margem</th><th class="py-2 pr-2 text-right"></th></tr></thead>
                    <tbody id="dash-tbody" class="text-sm"></tbody>
                </table>
            </div>

            <!-- BARRA DE A√á√ïES DASHBOARD -->
            <div class="action-bar flex justify-end gap-3 mt-4 pt-3 border-t border-gray-200 no-print">
                <button onclick="imprimirRelatorio('dash')" class="text-[10px] font-bold text-gray-600 hover:text-gray-800 flex items-center gap-1 uppercase">
                    <i class="fas fa-print"></i> Imprimir Portfolio
                </button>
                <button onclick="exportarBackup()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 uppercase">
                    <i class="fas fa-download"></i> Exportar
                </button>
                <label class="text-[10px] font-bold text-green-600 hover:text-green-800 flex items-center gap-1 uppercase cursor-pointer">
                    <i class="fas fa-upload"></i> Importar
                    <input type="file" id="import-file-dash" class="hidden" onchange="importarBackup(this)">
                </label>
            </div>
        </div>
        
        <div class="bg-gray-50 px-6 py-4 text-center border-t border-gray-100 no-print">
            <p class="text-[10px] text-gray-400">¬© 2024 Velt.AI | CPC M√≠nimo Shopee: R$ 0,11.</p>
        </div>

    </div>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, writeBatch, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. CONFIGURA√á√ÉO FIREBASE
    const firebaseConfig = {
        apiKey: "AIzaSyA1oGBZhcHQDcDxUqCc_UrRDA4gt_yf5Os",
        authDomain: "calculadora-shopee-v2.firebaseapp.com",
        projectId: "calculadora-shopee-v2",
        storageBucket: "calculadora-shopee-v2.firebasestorage.app",
        messagingSenderId: "68009609811",
        appId: "1:68009609811:web:80bb87c668ffd54b0b54a6"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Global variables accessible to window
    window.currentUser = null;
    window.productsCache = {};
    window.selectedAdsProduct = null;

    // Helper functions global
    window.getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
    
    window.safeSetText = (id, text) => {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    };

    // Vari√°veis Globais de Elementos (Definidas no topo para garantir acesso)
    let margemSlider = null;

    // 2. AUTH SYSTEM
    const initAuth = async () => {};
    initAuth();

    onAuthStateChanged(auth, (user) => {
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        if (user) {
            window.currentUser = user;
            loginScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            let displayName = user.email ? user.email.split('@')[0] : 'Convidado';
            document.getElementById('auth-status').innerText = `${displayName}`;
            document.getElementById('auth-status').classList.add("text-green-500");
            initFirestoreListener();
        } else {
            window.currentUser = null;
            loginScreen.classList.remove('hidden');
            appContent.classList.add('hidden');
            document.getElementById('auth-status').innerText = "Desconectado";
        }
    });

    window.fazerLogin = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-login');

        if (!email || !pass) return showError("Preencha e-mail e senha.");

        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;
        document.getElementById('login-error').classList.add('hidden');

        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (error) {
            console.error(error);
            handleAuthError(error);
            btn.innerText = "Entrar";
            btn.disabled = false;
        }
    };

    window.fazerCadastro = async () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-register');
        if (!email || !pass) return showError("Preencha dados.");
        if (pass.length < 6) return showError("Senha min 6 chars.");
        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;
        try { await createUserWithEmailAndPassword(auth, email, pass); } catch (error) { handleAuthError(error); btn.innerText = originalText; btn.disabled = false; }
    };
    
    window.fazerLoginAnonimo = async () => {
        const btn = document.getElementById('btn-guest');
        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;
        try { await signInAnonymously(auth); } catch (error) { handleAuthError(error); btn.innerText = originalText; btn.disabled = false; }
    };

    window.fazerLogout = async () => { try { await signOut(auth); } catch (error) { console.error(error); } };

    function handleAuthError(error) {
        if (error.code === 'auth/operation-not-allowed') {
            document.getElementById('firebase-help').classList.remove('hidden');
            showError("Configura√ß√£o Pendente no Firebase.");
        } else {
            showError(error.message);
        }
    }

    function showError(msg) {
        const errDiv = document.getElementById('login-error');
        errDiv.innerText = msg;
        errDiv.classList.remove('hidden');
        document.getElementById('btn-login').disabled = false;
        document.getElementById('btn-login').innerText = "Entrar";
    }

    function initFirestoreListener() {
        if (!window.currentUser) return;
        const productsRef = collection(db, 'users', window.currentUser.uid, 'products');
        onSnapshot(productsRef, (snapshot) => {
            const select = document.getElementById('saved-products');
            const selectAds = document.getElementById('ads-saved-products'); 
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione um produto...</option>';
            selectAds.innerHTML = '<option value="">-- Selecione para comparar --</option>'; 
            window.productsCache = {};
            snapshot.forEach((doc) => {
                const data = doc.data();
                window.productsCache[doc.id] = data;
                const option = document.createElement('option');
                option.value = doc.id;
                option.innerText = data.name;
                select.appendChild(option);
                const optionAds = document.createElement('option');
                optionAds.value = doc.id;
                optionAds.innerText = data.name;
                selectAds.appendChild(optionAds);
            });
            if(window.productsCache[currentVal]) select.value = currentVal;
            if(document.getElementById('view-dash').classList.contains('block')) updateDashboardTable();
        });
    }

    const nameInput = document.getElementById('prod-name');
    nameInput.addEventListener('input', (e) => {
        let val = e.target.value;
        if(val.length > 0) {
            const firstLetter = val.charAt(0).toUpperCase();
            const rest = val.slice(1);
            const formatted = (firstLetter + rest).replace(/\s+/g, '_');
            e.target.value = formatted;
        }
    });
    
    const dashSearchInput = document.getElementById('dash-search');
    if(dashSearchInput) {
        dashSearchInput.addEventListener('input', (e) => {
            window.updateDashboardTable();
        });
    }

    window.novoProduto = () => {
        document.getElementById('prod-id').value = "";
        document.getElementById('prod-name').value = "";
        document.getElementById('saved-products').value = "";
        document.getElementById('badge-mode').innerText = "NOVO";
        document.getElementById('badge-mode').className = "bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
        document.getElementById('btn-save-text').innerText = "Salvar";
        document.getElementById('btn-delete').classList.add('hidden');
        document.getElementById('custo').value = "";
        document.getElementById('preco-venda').value = "";
        document.getElementById('extra').value = "0.00";
        document.getElementById('devolucao').value = "0";
        
        window.atualizarPrecificacao('slider');
    };

    window.excluirProduto = async () => {
        const docId = document.getElementById('prod-id').value;
        if (!window.currentUser || !docId) return alert("Selecione um produto.");
        if(confirm("Excluir produto?")) {
            try {
                const collectionRef = collection(db, 'users', window.currentUser.uid, 'products');
                await deleteDoc(doc(collectionRef, docId));
                alert("Exclu√≠do!");
                window.novoProduto();
            } catch(e) { console.error(e); }
        }
    };

    window.salvarProduto = async () => {
        if (!window.currentUser) return alert("Fa√ßa login.");
        const name = document.getElementById('prod-name').value;
        if (!name) return alert("Nome obrigat√≥rio.");

        const productData = {
            name: name,
            custo: document.getElementById('custo').value,
            extra: document.getElementById('extra').value,
            taxaFixa: document.getElementById('taxa-fixa').value,
            comissao: document.getElementById('comissao').value,
            imposto: document.getElementById('imposto').value,
            devolucao: document.getElementById('devolucao').value,
            descCupom: document.getElementById('desc-cupom').value,
            descRelampago: document.getElementById('desc-relampago').value,
            margem: document.getElementById('margem-slider').value,
            precoVenda: document.getElementById('preco-venda').value,
            adsMode: document.getElementById('ads-mode').value,
            adsInput: document.getElementById('ads-input').value,
            perfilAds: document.getElementById('perfil-ads').value,
            customCpa: document.getElementById('custom-cpa').value, 
            updatedAt: new Date().toISOString()
        };

        const btn = document.getElementById('btn-save');
        const originalText = document.getElementById('btn-save-text').innerText;
        document.getElementById('btn-save-text').innerText = "Salvando...";
        btn.disabled = true;

        try {
            let docId = document.getElementById('prod-id').value;
            const collectionRef = collection(db, 'users', window.currentUser.uid, 'products');
            if (docId && window.productsCache[docId]) {
                await updateDoc(doc(collectionRef, docId), productData);
            } else {
                const newRef = doc(collectionRef);
                docId = newRef.id;
                await setDoc(newRef, productData);
                document.getElementById('prod-id').value = docId;
                document.getElementById('badge-mode').innerText = `ID: ${docId.slice(0,4)}...`;
                document.getElementById('badge-mode').className = "bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
                document.getElementById('btn-delete').classList.remove('hidden');
            }
            document.getElementById('btn-save-text').innerText = "Salvo!";
            setTimeout(() => { document.getElementById('btn-save-text').innerText = "Salvar"; btn.disabled = false; }, 2000);
        } catch (e) { console.error(e); alert("Erro ao salvar."); document.getElementById('btn-save-text').innerText = originalText; btn.disabled = false; }
    };

    window.carregarProduto = (id) => {
        if (!id || !window.productsCache[id]) return;
        window.switchTab('calc');
        const data = window.productsCache[id];
        document.getElementById('prod-id').value = id;
        document.getElementById('prod-name').value = data.name;
        document.getElementById('badge-mode').innerText = `ID: ${id.slice(0,4)}...`;
        document.getElementById('badge-mode').className = "bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
        document.getElementById('btn-delete').classList.remove('hidden');
        document.getElementById('btn-save-text').innerText = "Atualizar";
        
        let loadedAdsInput = data.adsInput;
        if(loadedAdsInput === undefined || loadedAdsInput === null) loadedAdsInput = data.cpcEst || 0.11;

        const fields = {
            'custo': data.custo, 
            'extra': data.extra, 
            'taxa-fixa': data.taxaFixa || data['taxa-fixa'], 
            'comissao': data.comissao, 
            'imposto': data.imposto, 
            'devolucao': data.devolucao,
            'desc-cupom': data.descCupom || data['desc-cupom'], 
            'desc-relampago': data.descRelampago || data['desc-relampago'],
            'margem-slider': data.margem, 
            'preco-venda': data.precoVenda || data['preco-venda'], 
            'ads-mode': data.adsMode || 'cpc', 
            'ads-input': loadedAdsInput,
            'perfil-ads': data.perfilAds, 
            'custom-cpa': data.customCpa || 10.00
        };

        for (const [key, val] of Object.entries(fields)) {
            const el = document.getElementById(key);
            if(el) el.value = val !== undefined ? val : (key === 'extra' || key === 'devolucao' ? 0 : el.value);
        }
        
        if(data.margem) {
             document.getElementById('label-margem').innerText = data.margem + "%";
        }
        
        window.toggleAdsMode();
        window.toggleAdsProfile();
        // Use 'manual' para preservar o pre√ßo carregado sem recalcular pelo slider
        window.atualizarPrecificacao('manual'); 
        window.calcularGeral(false);
    };

    window.limparCalculadora = () => {
        if(!confirm("Tem certeza que deseja limpar todos os campos da calculadora?")) return;
        
        // Usar fun√ß√£o segura que busca elementos atuais
        const inputsToClear = ['custo', 'extra', 'taxa-fixa', 'comissao', 'imposto', 'desc-relampago', 'desc-cupom', 'devolucao', 'preco-venda', 'ads-input', 'custom-cpa', 'prod-name', 'prod-id'];
        inputsToClear.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = "";
        });
        
        const slider = document.getElementById('margem-slider');
        if(slider) slider.value = 15;
        
        const perfil = document.getElementById('perfil-ads');
        if(perfil) perfil.selectedIndex = 0;
        
        const adsMode = document.getElementById('ads-mode');
        if(adsMode) adsMode.value = 'cpc';
        
        const saved = document.getElementById('saved-products');
        if(saved) saved.value = "";
        
        // Reset state UI
        const badge = document.getElementById('badge-mode');
        if(badge) {
            badge.innerText = "NOVO";
            badge.className = "bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold text-[9px]";
        }
        
        const btnSaveText = document.getElementById('btn-save-text');
        if(btnSaveText) btnSaveText.innerText = "Salvar";
        
        const btnDelete = document.getElementById('btn-delete');
        if(btnDelete) btnDelete.classList.add('hidden');
        
        window.toggleAdsMode();
        window.toggleAdsProfile();
        window.atualizarPrecificacao('slider');
        window.calcularGeral(false);
    }

    window.exportarBackup = () => {
        if (Object.keys(window.productsCache).length === 0) return alert("Nenhum produto.");
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.productsCache));
        const link = document.createElement('a');
        link.setAttribute("href", dataStr);
        link.setAttribute("download", "backup_shopee_ads.json");
        document.body.appendChild(link);
        link.click();
        link.remove();
    };

    window.importarBackup = async (input) => {
        if (!window.currentUser) return;
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const json = JSON.parse(e.target.result);
                const batch = writeBatch(db);
                let count = 0;
                const collectionRef = collection(db, 'users', window.currentUser.uid, 'products');
                for (const [id, data] of Object.entries(json)) { batch.set(doc(collectionRef, id), data); count++; }
                await batch.commit();
                alert(`${count} importados!`);
            } catch (err) { alert("Erro import."); }
        };
        reader.readAsText(file);
    };

    window.switchTab = (tab) => {
        const calcBtn = document.getElementById('tab-calc');
        const adsBtn = document.getElementById('tab-ads');
        const dashBtn = document.getElementById('tab-dash');
        const viewCalc = document.getElementById('view-calc');
        const viewAds = document.getElementById('view-ads-analysis');
        const viewDash = document.getElementById('view-dash');
        
        [calcBtn, adsBtn, dashBtn].forEach(btn => btn.className = "flex-1 py-4 text-xs font-bold text-gray-400 border-b-2 border-transparent hover:bg-gray-50 uppercase tracking-wide transition-colors");
        [viewCalc, viewAds, viewDash].forEach(view => view.classList.add('hidden'));

        if(tab === 'calc') {
            calcBtn.className = "flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 transition-colors";
            viewCalc.classList.remove('hidden');
        } else if (tab === 'ads') {
            adsBtn.className = "flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 transition-colors";
            viewAds.classList.remove('hidden');
        } else {
            dashBtn.className = "flex-1 py-4 text-xs font-bold text-orange-600 border-b-2 border-orange-500 bg-orange-50 transition-colors";
            viewDash.classList.remove('hidden');
            updateDashboardTable();
        }
    }

    window.updateDashboardTable = () => {
        const tbody = document.getElementById('dash-tbody');
        const searchInput = document.getElementById('dash-search');
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";
        
        let ids = Object.keys(window.productsCache);
        
        if (searchTerm) {
            ids = ids.filter(id => {
                const p = window.productsCache[id];
                return p.name.toLowerCase().includes(searchTerm);
            });
        }

        document.getElementById('dash-count').innerText = `${ids.length} produtos`;

        if(ids.length === 0) { 
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">' + (searchTerm ? 'Nenhum produto encontrado.' : 'Vazio.') + '</td></tr>'; 
            return; 
        }

        let html = '';
        ids.forEach(id => {
            const p = window.productsCache[id];
            const pBase = parseFloat(p.precoVenda) || 0;
            const custo = parseFloat(p.custo) || 0;
            const extra = parseFloat(p.extra) || 0;
            const fixo = parseFloat(p.taxaFixa) || 0;
            
            const descC = (parseFloat(p.descCupom) || 0) / 100;
            const descR = (parseFloat(p.descRelampago) || 0) / 100;
            const pAposRelampago = pBase * (1 - descR);
            const pFinal = pAposRelampago * (1 - descC);
            
            const comissao = (parseFloat(p.comissao)||0)/100;
            const imposto = (parseFloat(p.imposto)||0)/100;
            const devolucao = (parseFloat(p.devolucao)||0)/100;
            
            const taxasTotal = pFinal * (comissao + imposto + devolucao);
            const lucro = pFinal - custo - extra - fixo - taxasTotal;
            const margem = pFinal > 0 ? (lucro / pFinal) * 100 : 0;

            const lucroClass = lucro >= 0 ? "text-green-600" : "text-red-600";
            const margemClass = margem >= 15 ? "bg-green-100 text-green-800" : (margem > 0 ? "bg-yellow-100 text-yellow-800" : "bg-red-100 text-red-800");

            html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                <td class="py-3 pl-2 font-bold text-gray-700">${p.name}</td>
                <td class="py-3 text-gray-600">R$ ${pFinal.toFixed(2)}</td>
                <td class="py-3 text-gray-400 text-xs">R$ ${custo.toFixed(2)}</td>
                <td class="py-3 font-bold ${lucroClass}">R$ ${lucro.toFixed(2)}</td>
                <td class="py-3 text-center"><span class="text-[10px] font-bold px-2 py-1 rounded-full ${margemClass}">${margem.toFixed(1)}%</span></td>
                <td class="py-3 pr-2 text-right"><button onclick="carregarProduto('${id}')" class="text-blue-500 text-xs font-bold uppercase">Editar</button></td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    const els = {};
    const ids = ['custo', 'extra', 'taxa-fixa', 'comissao', 'imposto', 'devolucao', 'desc-cupom', 'desc-relampago', 'preco-venda', 'ads-input', 'perfil-ads', 'custom-cpa', 'camp-impressions', 'camp-clicks', 'camp-expense', 'camp-gmv', 'camp-conversions', 'camp-items'];
    ids.forEach(id => els[id] = document.getElementById(id));
    
    // Obter o slider no momento do uso para evitar erro de refer√™ncia
    function getMargemSlider() {
        return document.getElementById('margem-slider');
    }
    
    function calcularPrecoFinal(precoBase) {
        const descCupom = window.getVal('desc-cupom') / 100;
        const descRelampago = window.getVal('desc-relampago') / 100;
        
        // Ordem: Oferta Rel√¢mpago -> Cupom Loja
        const aposRelampago = precoBase * (1 - descRelampago);
        return aposRelampago * (1 - descCupom);
    }
    
    // NEW: Function to render the Organic Simulation Table
    window.renderizarSimulacaoOrganica = function(precoBase, custo, extra, fixo) { 
        const descCupom = window.getVal('desc-cupom') / 100;
        const descRelampagoBase = window.getVal('desc-relampago'); // Integer percentage
        
        const comissao = window.getVal('comissao') / 100;
        const imposto = window.getVal('imposto') / 100;
        const devolucao = window.getVal('devolucao') / 100;
        
        const fixedCosts = custo + extra + fixo;

        let html = '';
        
        // Loop for simulation: Base + 1% to Base + 10%
        for(let i = 1; i <= 10; i++) {
            const simDescPct = descRelampagoBase + i; 
            const simDescDecimal = simDescPct / 100;
            
            // Calculate Scenario CORRECTLY as per user request:
            // 1. Discount Lightning Deal from Base Price
            const priceOffer = precoBase * (1 - simDescDecimal);
            // 2. Discount Shop Coupon from resulting price
            const priceFinal = priceOffer * (1 - descCupom);
            
            // Tax is on final price
            const totalTaxVal = priceFinal * (comissao + imposto + devolucao);
            
            // Profit
            const profit = priceFinal - fixedCosts - totalTaxVal;
            const margin = priceFinal > 0 ? (profit / priceFinal) * 100 : 0;
            
            const profitClass = profit >= 0 ? "text-green-600" : "text-red-600";
            const marginClass = margin > 0 ? "bg-green-50 text-green-800" : "bg-red-50 text-red-800";

            html += `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="px-3 py-2 text-center text-gray-700 font-bold">${simDescPct.toFixed(0)}%</td>
                <td class="px-3 py-2 text-right text-gray-600">R$ ${priceFinal.toFixed(2)}</td> <!-- Changed to priceFinal per user request -->
                <td class="px-3 py-2 text-right font-bold ${profitClass}">R$ ${profit.toFixed(2)}</td>
                <td class="px-3 py-2 text-center">
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold ${marginClass}">${margin.toFixed(1)}%</span>
                </td>
            </tr>
            `;
        }
        
        const tbody = document.getElementById('organic-simulation-body');
        if(tbody) tbody.innerHTML = html;
        
        // Make sure the wrapper is visible
        const wrapper = document.getElementById('organic-simulation-wrapper');
        if(wrapper) wrapper.classList.remove('hidden');
    }
    
    // CUSTOM SIMULATION HANDLER
    window.simularDescontoPersonalizado = function() {
        const inputVal = parseFloat(document.getElementById('sim-custom-pct').value) || 0;
        const precoBase = window.getVal('preco-venda');
        const descCupom = window.getVal('desc-cupom') / 100;
        
        // Similar calculation to loop
        const simDescDecimal = inputVal / 100;
        const priceOffer = precoBase * (1 - simDescDecimal);
        const priceFinal = priceOffer * (1 - descCupom);
        
        const custo = window.getVal('custo');
        const extra = window.getVal('extra');
        const fixo = window.getVal('taxa-fixa');
        const comissao = window.getVal('comissao') / 100;
        const imposto = window.getVal('imposto') / 100;
        const devolucao = window.getVal('devolucao') / 100;
        
        const totalTaxVal = priceFinal * (comissao + imposto + devolucao);
        const profit = priceFinal - (custo + extra + fixo) - totalTaxVal;
        const margin = priceFinal > 0 ? (profit / priceFinal) * 100 : 0;
        
        window.safeSetText('sim-custom-price', "R$ " + priceFinal.toFixed(2));
        const profitEl = document.getElementById('sim-custom-profit');
        if(profitEl) {
            profitEl.innerText = "R$ " + profit.toFixed(2);
            profitEl.className = profit >= 0 ? "font-bold text-green-600" : "font-bold text-red-600";
        }
        window.safeSetText('sim-custom-margin', margin.toFixed(1) + "%");
    }


    window.toggleAdsMode = function() {
        const mode = document.getElementById('ads-mode').value;
        const label = document.getElementById('lbl-ads-input');
        const input = document.getElementById('ads-input');
        const container = document.getElementById('ads-input-container');
        if(mode === 'none') { container.classList.add('hidden'); } else { container.classList.remove('hidden'); if(mode === 'cpc') label.innerText = "CPC Estimado (R$)"; else label.innerText = "Convers√£o Estimada (%)"; }
    }
    
    window.toggleAdsProfile = function() {
        const perfil = document.getElementById('perfil-ads').value;
        const customContainer = document.getElementById('custom-cpa-container');
        if(perfil === 'custom') customContainer.classList.remove('hidden'); else customContainer.classList.add('hidden');
    }

    const triggerUpdate = (source) => { window.atualizarPrecificacao(source); window.calcularGeral(false); };
    ['custo', 'extra', 'taxa-fixa', 'comissao', 'imposto', 'devolucao', 'desc-cupom', 'desc-relampago'].forEach(id => {
         const el = document.getElementById(id);
         if(el) el.addEventListener('input', () => {
             // If these change, update main calc AND sim
             triggerUpdate('slider');
         });
    });
    
    const sliderEl = document.getElementById('margem-slider');
    if(sliderEl) sliderEl.addEventListener('input', () => triggerUpdate('slider'));

    ['ads-input', 'custom-cpa'].forEach(id => {
         const el = document.getElementById(id);
         if(el) el.addEventListener('input', () => window.calcularGeral(false));
    });
    
    const pvEl = document.getElementById('preco-venda');
    if(pvEl) pvEl.addEventListener('input', () => triggerUpdate('manual'));


    window.atualizarPrecificacao = function(origem) {
        // 1. Update UI Label immediately
        const slider = getMargemSlider();
        
        if (origem === 'slider' && slider) {
             const label = document.getElementById('label-margem');
             if(label) label.innerText = slider.value + "%";
        }
        
        const custo = window.getVal('custo');
        const extra = window.getVal('extra');
        const fixo = window.getVal('taxa-fixa');
        const taxasVariaveis = (window.getVal('comissao') + window.getVal('imposto') + window.getVal('devolucao')) / 100;
        const custosFixosReais = custo + extra + fixo;

        if (custo === 0) return;

        if (origem === 'slider' && slider) {
            const margemDesejada = parseFloat(slider.value) / 100;
            const divisor = 1 - taxasVariaveis - margemDesejada;
            const pvInput = document.getElementById('preco-venda');
            
            if (divisor <= 0.05) { 
                if(pvInput) pvInput.value = 0; 
                return; 
            }
            
            const precoFinalAlvo = custosFixosReais / divisor;
            const descCupom = window.getVal('desc-cupom') / 100;
            const descRelampago = window.getVal('desc-relampago') / 100;
            
            const fatorDescontos = (1 - descCupom) * (1 - descRelampago);
            let precoBaseSugerido = precoFinalAlvo / fatorDescontos;
            precoBaseSugerido = Math.ceil(precoBaseSugerido - 0.90) + 0.90;
            
            if(pvInput) pvInput.value = precoBaseSugerido.toFixed(2);
        }

        const precoBase = window.getVal('preco-venda');
        const precoFinal = calcularPrecoFinal(precoBase);
        window.safeSetText('preco-final-display', "R$ " + precoFinal.toFixed(2));
        
        const custoTotalTaxas = precoFinal * taxasVariaveis;
        const lucroLiquido = precoFinal - custosFixosReais - custoTotalTaxas;
        
        const elLucro = document.getElementById('lucro-real');
        if (elLucro) {
            elLucro.innerText = "R$ " + lucroLiquido.toFixed(2);
            elLucro.className = lucroLiquido < 0 ? "text-xl font-black text-red-600" : "text-xl font-black text-green-600";
        }
    };

    window.calcularGeral = function(scroll = true) {
        const custo = window.getVal('custo');
        const extra = window.getVal('extra');
        const fixo = window.getVal('taxa-fixa');
        const precoBase = window.getVal('preco-venda');
        const taxasVariaveis = (window.getVal('comissao') + window.getVal('imposto') + window.getVal('devolucao')) / 100;
        const adsMode = document.getElementById('ads-mode').value;
        const adsInput = window.getVal('ads-input');
        const perfilAds = document.getElementById('perfil-ads').value;

        const precoFinal = calcularPrecoFinal(precoBase);
        const custoTotalTaxas = precoFinal * taxasVariaveis;
        const lucroUnit = precoFinal - (custo + extra + fixo) - custoTotalTaxas;
        
        let cpaAlvo = 0;
        if (perfilAds === 'custom') cpaAlvo = window.getVal('custom-cpa');
        else if (perfilAds == 0) cpaAlvo = 0; 
        else cpaAlvo = Math.max(lucroUnit * 0.5, lucroUnit * parseFloat(perfilAds));
        
        let displayMainVal = "", displayMainLabel = "", displayMainSub = "";
        
        // --- ALWAYS SHOW SIMULATION ---
        window.renderizarSimulacaoOrganica(precoBase, custo, extra, fixo);

        // Ads Metrics Logic
        if (perfilAds == 0) {
            displayMainLabel = "Estrat√©gia Org√¢nica"; displayMainVal = "Sem Ads"; displayMainSub = "Foco em SEO";
            checkVereditoOrganic(lucroUnit);
        } else {
            if (adsMode === 'cpc' || adsMode === 'none') {
                const cpc = adsMode === 'none' ? 0.11 : adsInput;
                const convMin = cpaAlvo > 0 ? (cpc / cpaAlvo) * 100 : 0;
                displayMainLabel = "Taxa de Convers√£o M√≠nima"; displayMainVal = convMin.toFixed(2) + "%"; displayMainSub = "Para CPC R$ " + cpc.toFixed(2);
                checkVereditoConv(lucroUnit, convMin);
            } else {
                const conv = adsInput;
                const cpcMax = cpaAlvo * (conv / 100);
                displayMainLabel = "CPC M√°ximo Permitido"; displayMainVal = "R$ " + cpcMax.toFixed(2); displayMainSub = `Com convers√£o de ${conv}%`;
                checkVereditoCPC(lucroUnit, cpcMax);
            }
        }

        const roasBreakeven = (lucroUnit > 0) ? (precoFinal / lucroUnit) : 0;
        const roasIdeal = (cpaAlvo > 0) ? (precoFinal / cpaAlvo) : 0;
        const acosBreakeven = roasBreakeven > 0 ? (100 / roasBreakeven) : 0;
        const acosIdeal = roasIdeal > 0 ? (100 / roasIdeal) : 0;
        const lucroPosAds = lucroUnit - cpaAlvo;

        window.safeSetText('res-cpa', "R$ " + cpaAlvo.toFixed(2));
        
        const elSobra = document.getElementById('res-cpa-restante');
        if (elSobra) {
            elSobra.innerText = "Sobra: R$ " + lucroPosAds.toFixed(2);
            elSobra.className = lucroPosAds >= 0 ? "block text-[10px] font-bold text-green-600 mt-1" : "block text-[10px] font-bold text-red-500 mt-1";
        }

        window.safeSetText('lbl-res-secondary', displayMainLabel);
        window.safeSetText('res-secondary-val', displayMainVal);
        window.safeSetText('res-secondary-sub', displayMainSub);

        if(perfilAds == 0) {
            window.safeSetText('res-roas-ideal', "ROAS: -"); window.safeSetText('res-acos-ideal', "ACOS: 0%");
        } else {
            window.safeSetText('res-roas-ideal', "ROAS: " + roasIdeal.toFixed(2)); window.safeSetText('res-acos-ideal', "ACOS: " + acosIdeal.toFixed(1) + "%");
        }
        window.safeSetText('res-roas-breakeven', "ROAS: " + roasBreakeven.toFixed(2));
        window.safeSetText('res-acos-breakeven', "ACOS: " + acosBreakeven.toFixed(1) + "%");

        renderizarProvaReal(precoBase, custo, extra, fixo);
        const resArea = document.getElementById('results-area');
        if(resArea) {
            resArea.classList.remove('hidden');
            if(scroll) resArea.scrollIntoView({ behavior: 'smooth' });
        }
    };

    function checkVereditoOrganic(lucroUnit) {
        setVeredito(lucroUnit <= 0 ? 'red' : 'green', lucroUnit <= 0 ? 'PREJU√çZO' : 'LUCRO ORG√ÇNICO', lucroUnit <= 0 ? 'Margem negativa.' : 'Sem custos de ads.');
    }
    function checkVereditoConv(lucroUnit, convMin) {
        if (lucroUnit <= 0) setVeredito('red', 'PREJU√çZO', 'Margem negativa.');
        else if (convMin > 3.0) setVeredito('red', 'DIF√çCIL', `Precisa de ${convMin.toFixed(1)}% conv.`);
        else if (convMin < 1.0) setVeredito('green', 'MUITO VI√ÅVEL', `Meta f√°cil: ${convMin.toFixed(1)}%.`);
        else setVeredito('blue', 'VI√ÅVEL', `Meta de ${convMin.toFixed(1)}% ok.`);
    }
    function checkVereditoCPC(lucroUnit, cpcMax) {
        if (lucroUnit <= 0) setVeredito('red', 'PREJU√çZO', 'Margem negativa.');
        else if (cpcMax < 0.11) setVeredito('red', 'INVI√ÅVEL', `Teto R$ ${cpcMax.toFixed(2)} < M√≠nimo.`);
        else setVeredito('blue', 'VI√ÅVEL', `Teto de R$ ${cpcMax.toFixed(2)} ok.`);
    }
    
    function setVeredito(color, title, desc) {
        const cont = document.getElementById('veredito-container');
        const icon = document.getElementById('veredito-icon');
        const tit = document.getElementById('veredito-titulo');
        const txt = document.getElementById('veredito-texto');
        
        if (!cont || !icon || !tit || !txt) return;

        const colors = { red: ['border-red-500', 'bg-red-50', 'text-red-500'], green: ['border-green-500', 'bg-green-50', 'text-green-500'], blue: ['border-blue-500', 'bg-blue-50', 'text-blue-500'] };
        const c = colors[color];
        cont.className = `p-4 rounded-xl border-l-4 shadow-sm flex items-start gap-3 ${c[1]} ${c[0]}`;
        icon.className = `text-2xl mt-1 ${c[2]}`;
        icon.innerHTML = color === 'red' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-check-circle"></i>';
        tit.innerText = title; tit.className = `font-bold text-sm uppercase ${c[2]}`; txt.innerText = desc;
    }

    // MAKE THIS GLOBAL SO simularRelampago CAN CALL IT
    window.renderizarProvaReal = function(precoBase, custo, extra, fixo, customRelampagoPct = null) {
        const descCupom = window.getVal('desc-cupom'); 
        
        // Use custom percentage if provided (from simulation), otherwise use saved input value
        let descRelampago = 0;
        if (customRelampagoPct !== null) {
             descRelampago = customRelampagoPct;
        } else {
             descRelampago = window.getVal('desc-relampago') / 100;
        }

        const comissao = window.getVal('comissao'); const imposto = window.getVal('imposto'); const devolucao = window.getVal('devolucao');
        
        const valDescRelampago = precoBase * descRelampago; 
        const precoAposRelampago = precoBase - valDescRelampago;
        const valDescCupom = precoAposRelampago * (descCupom / 100); 
        const precoFinal = precoAposRelampago - valDescCupom;
        
        const valComissao = precoFinal * (comissao / 100); 
        const valImposto = precoFinal * (imposto / 100); 
        const valDevolucao = precoFinal * (devolucao / 100);
        
        const custoTotal = custo + extra + fixo + valComissao + valImposto + valDevolucao; 
        const lucroFinal = precoFinal - custoTotal;
        
        const margemFinal = precoFinal > 0 ? (lucroFinal / precoFinal) * 100 : 0;
        
        const container = document.getElementById('breakdown-container');
        if (!container) return;

        const row = (lbl, pct, val, clr) => `<div class="flex justify-between items-center"><span class="${clr}">${lbl} ${pct?`(${pct}%)`:''}</span><span class="${clr}">${val < 0 ? '-' : ''} R$ ${Math.abs(val).toFixed(2)}</span></div>`;
        
        container.innerHTML = `
            ${row('Pre√ßo de Venda (Base)', null, precoBase, 'font-bold text-gray-800')}
            ${descRelampago > 0 ? row('(-) Oferta Rel√¢mpago', (descRelampago*100).toFixed(0), -valDescRelampago, 'text-red-500') : ''}
            ${descCupom > 0 ? row('(-) Cupom Loja', descCupom, -valDescCupom, 'text-red-500') : ''}
            <div class="border-t border-dashed border-gray-300 my-2"></div>
            ${row('(=) Pre√ßo Venda (Nota Fiscal)', null, precoFinal, 'font-bold text-blue-800')}
            ${devolucao > 0 ? row('(-) Devolu√ß√£o Estimada', devolucao, -valDevolucao, 'text-red-500 font-bold') : ''}
            ${row('(-) Custo do Produto', null, -custo, 'text-red-400')}
            ${row('(-) Custos Extras', null, -extra, 'text-red-400')}
            ${row('(-) Taxa Fixa Shopee', null, -fixo, 'text-red-400')}
            ${row('(-) Comiss√£o Shopee', comissao, -valComissao, 'text-red-400')}
            ${row('(-) Impostos', imposto, -valImposto, 'text-red-400')}
            <div class="border-t border-gray-300 mt-2 pt-2 flex justify-between font-black ${lucroFinal>=0?'text-green-600':'text-red-600'}">
                <span>(=) LUCRO L√çQUIDO FINAL</span><span>R$ ${lucroFinal.toFixed(2)}</span>
            </div>
            <div class="text-right text-[10px] text-gray-400">Margem Real: ${margemFinal.toFixed(2)}%</div>
        `;
    }

    window.carregarProdutoAds = function(id) {
        if (!id || !window.productsCache[id]) { window.selectedAdsProduct = null; document.getElementById('ads-product-info').classList.add('hidden'); return; }
        const p = window.productsCache[id];
        const pBase = parseFloat(p.precoVenda)||0; const custo = parseFloat(p.custo)||0; const extra = parseFloat(p.extra)||0; const fixo = parseFloat(p.taxaFixa)||0;
        const descC = (parseFloat(p.descCupom)||0)/100; const descR = (parseFloat(p.descRelampago)||0)/100;
        const pFinal = (pBase * (1-descR)) * (1-descC);
        const comissao = (parseFloat(p.comissao)||0)/100; const imposto = (parseFloat(p.imposto)||0)/100; const devolucao = (parseFloat(p.devolucao)||0)/100;
        const taxasTotal = pFinal * (comissao + imposto + devolucao);
        const lucroUnit = pFinal - custo - extra - fixo - taxasTotal;
        const margem = pFinal > 0 ? (lucroUnit / pFinal) * 100 : 0;
        const targetCpa = (p.perfilAds === 'custom') ? (parseFloat(p.customCpa)||0) : (p.perfilAds == 0 ? 0 : Math.max(lucroUnit * 0.5, lucroUnit * parseFloat(p.perfilAds||0.5)));
        const targetRoas = targetCpa > 0 ? (pFinal / targetCpa) : 0;
        
        window.selectedAdsProduct = { name: p.name, lucroUnit: lucroUnit, margem: margem, targetRoas: targetRoas, targetCpa: targetCpa };
        
        window.safeSetText('ads-info-margin', margem.toFixed(1) + "%");
        window.safeSetText('ads-info-profit', "R$ " + lucroUnit.toFixed(2));
        window.safeSetText('ads-info-roas', targetRoas.toFixed(2));
        document.getElementById('ads-product-info').classList.remove('hidden');
        analisarCampanha();
    };

    window.analisarCampanha = function() {
        const impress = window.getVal('camp-impressions'); const clicks = window.getVal('camp-clicks'); const expense = window.getVal('camp-expense');
        const gmv = window.getVal('camp-gmv'); const conversions = window.getVal('camp-conversions'); const items = window.getVal('camp-items');
        const resultDiv = document.getElementById('camp-results');
        
        if(!resultDiv) return;
        if(clicks === 0 && expense === 0) { resultDiv.classList.add('hidden'); return; }
        resultDiv.classList.remove('hidden');

        const roas = expense > 0 ? (gmv / expense) : 0;
        const acos = gmv > 0 ? (expense / gmv) * 100 : 0;
        const ctr = impress > 0 ? (clicks / impress) * 100 : 0;
        const cr = clicks > 0 ? (conversions / clicks) * 100 : 0;
        const cpa = conversions > 0 ? (expense / conversions) : 0;
        const cpc = clicks > 0 ? (expense / clicks) : 0;

        window.safeSetText('res-camp-roas', roas.toFixed(2));
        window.safeSetText('res-camp-acos', acos.toFixed(1) + "%");
        window.safeSetText('res-camp-ctr', ctr.toFixed(2) + "%");
        window.safeSetText('res-camp-cr', cr.toFixed(2) + "%");
        window.safeSetText('res-camp-cpa', "R$ " + cpa.toFixed(2));
        window.safeSetText('res-camp-cpc', "R$ " + cpc.toFixed(2));
        window.safeSetText('res-camp-items', items);

        const profitBox = document.getElementById('camp-profit-box');
        const compTable = document.getElementById('comp-analysis-container');
        const compBody = document.getElementById('comp-analysis-body');
        const diagText = document.getElementById('comp-diagnostic-text');
        const verdictEl = document.getElementById('camp-verdict');

        if (window.selectedAdsProduct) {
            const quantitySold = items > 0 ? items : conversions;
            const netCampaignProfit = (quantitySold * window.selectedAdsProduct.lucroUnit) - expense;
            
            const profitEl = document.getElementById('res-camp-profit');
            if (profitEl) {
                profitEl.innerText = "R$ " + netCampaignProfit.toFixed(2);
                profitEl.className = netCampaignProfit >= 0 ? "text-2xl font-black text-green-600" : "text-2xl font-black text-red-600";
            }
            window.safeSetText('res-camp-profit-desc', `${quantitySold} itens x R$ ${window.selectedAdsProduct.lucroUnit.toFixed(2)} (lucro unit) - R$ ${expense.toFixed(2)} (ads)`);
            
            if(profitBox) profitBox.classList.remove('hidden');

            const targetCpa = window.selectedAdsProduct.targetCpa;
            const targetRoas = window.selectedAdsProduct.targetRoas;
            const targetConv = targetCpa > 0 ? (cpc / targetCpa) * 100 : 0;
            const maxCpc = targetCpa * (cr / 100);

            const row = (name, target, actual, isGood, goodTxt, badTxt) => `
                <tr class="bg-white border-b hover:bg-gray-50">
                    <td class="px-4 py-2 font-medium text-gray-900">${name}</td>
                    <td class="px-4 py-2 text-gray-500">${target}</td>
                    <td class="px-4 py-2 font-bold ${isGood ? 'text-green-600' : 'text-red-600'}">${actual}</td>
                    <td class="px-4 py-2 text-center text-xs">
                        <span class="${isGood ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-0.5 rounded-full">
                            ${isGood ? goodTxt : badTxt}
                        </span>
                    </td>
                </tr>
            `;

            let rows = "";
            rows += row('ROAS', `> ${targetRoas.toFixed(2)}`, roas.toFixed(2), roas >= targetRoas, 'Bom', 'Baixo');
            rows += row('CPA', `< R$ ${targetCpa.toFixed(2)}`, `R$ ${cpa.toFixed(2)}`, cpa <= targetCpa, 'Bom', 'Alto');
            rows += row('CPC (Ideal)', `< R$ ${maxCpc.toFixed(2)}`, `R$ ${cpc.toFixed(2)}`, cpc <= maxCpc, 'Eficiente', 'Caro');
            rows += row('Conv. (Nec.)', `> ${targetConv.toFixed(1)}%`, `${cr.toFixed(1)}%`, cr >= targetConv, '√ìtimo', 'Baixa');

            if(compBody) compBody.innerHTML = rows;

            let diagnosis = "";
            if (cpa > targetCpa) {
                diagnosis = `<strong class="text-red-700">üî¥ AN√ÅLISE T√âCNICA: CAMPANHA INEFICIENTE</strong><br>`;
                diagnosis += `<div class="mt-2 text-gray-700 text-xs space-y-1">`;
                if (cpc > maxCpc) {
                    diagnosis += `‚Ä¢ <b>CPC Inflacionado:</b> O leil√£o est√° caro (R$ ${cpc.toFixed(2)}). Para viabilizar, seu CTR precisa subir urgente. Teste novas capas.`;
                }
                if (cr < targetConv) {
                    diagnosis += `‚Ä¢ <b>Convers√£o Cr√≠tica:</b> Apenas ${cr.toFixed(2)}% compram. O tr√°fego chega e sai. Melhore descri√ß√£o, provas sociais ou revise se o pre√ßo est√° competitivo.`;
                }
                if (acos > window.selectedAdsProduct.margem) {
                     diagnosis += `‚Ä¢ <b>ACOS Explosivo:</b> Voc√™ gasta ${acos.toFixed(1)}% da venda em ads, mas sua margem √© ${window.selectedAdsProduct.margem.toFixed(1)}%. Preju√≠zo garantido.`;
                }
                diagnosis += `</div>`;
            } else {
                diagnosis = `
                    <strong class="text-green-700">üü¢ AN√ÅLISE T√âCNICA: CAMPANHA ESCAL√ÅVEL</strong><br>
                    <div class="mt-1 text-gray-600 text-xs">
                    M√©tricas saud√°veis. O CPA (R$ ${cpa.toFixed(2)}) permite lucro. <br>
                    <b>Pr√≥ximo passo:</b> Aumente o or√ßamento di√°rio em 20% a cada 3 dias para escalar sem perder a efici√™ncia (ROAS).
                    </div>
                `;
            }
            if(diagText) diagText.innerHTML = diagnosis;
            if(compTable) compTable.classList.remove('hidden');

             if (netCampaignProfit < 0) {
                 if(verdictEl) {
                     verdictEl.innerText = `PREJU√çZO OPERACIONAL: A campanha queimou R$ ${Math.abs(netCampaignProfit).toFixed(2)}. Pause palavras-chave amplas ou reduza o teto de lance.`;
                     verdictEl.className = "text-xs text-red-600 leading-relaxed font-bold";
                 }
             } else {
                 if(verdictEl) {
                     verdictEl.innerText = "LUCRO OPERACIONAL: O produto se paga. Foque em manter o ROAS est√°vel enquanto aumenta o volume.";
                     verdictEl.className = "text-xs text-green-600 leading-relaxed font-bold";
                 }
             }

        } else {
            if(profitBox) profitBox.classList.add('hidden');
            if(compTable) compTable.classList.add('hidden');
            
            if(verdictEl) {
                if(acos > 40) {
                    verdictEl.innerText = "Aten√ß√£o Cr√≠tica: O custo do an√∫ncio est√° consumindo mais de 40% da receita. Verifique margem.";
                    verdictEl.className = "text-xs text-red-600 leading-relaxed font-bold";
                } else if (roas < 3) {
                    verdictEl.innerText = "Alerta: ROAS baixo (< 3). Cuidado com preju√≠zo.";
                    verdictEl.className = "text-xs text-orange-600 leading-relaxed font-bold";
                } else {
                     verdictEl.innerText = "Saud√°vel: M√©tricas dentro de par√¢metros aceit√°veis.";
                     verdictEl.className = "text-xs text-green-600 leading-relaxed font-bold";
                }
            }
        }
    }
    
    // Fun√ß√£o de impress√£o com nome de arquivo e escopo de aba
    window.imprimirRelatorio = function() {
        const nomeProd = document.getElementById('prod-name').value || "Relatorio_VeltAI";
        let prefix = "Geral";
        
        // Determina qual aba est√° vis√≠vel para nomear o arquivo
        if(!document.getElementById('view-calc').classList.contains('hidden')) prefix = "Precificacao";
        else if(!document.getElementById('view-ads-analysis').classList.contains('hidden')) prefix = "Analise_Ads";
        else if(!document.getElementById('view-dash').classList.contains('hidden')) prefix = "Portfolio";

        const safeName = `${prefix}_${nomeProd.replace(/[^a-z0-9]/gi, '_').toLowerCase()}`;
        
        const originalTitle = document.title;
        document.title = safeName;
        window.print();
        
        // Timeout para garantir que o dialog de impress√£o pegou o t√≠tulo alterado
        setTimeout(() => {
            document.title = originalTitle;
        }, 1000);
    }
</script>

</body>
</html>
